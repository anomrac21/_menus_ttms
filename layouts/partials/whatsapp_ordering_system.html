<script>
// Dynamic location detection - will be updated based on visible location
let number = '{{ site.Params.orderingsystem.whatsapp }}'; // Fallback number
const name = '{{ site.Params.title }}'
const hastables = {{ default false site.Params.orderingsystem.hastables }};

// Function to update WhatsApp number based on visible location
function updateWhatsAppNumber() {
	console.log('updateWhatsAppNumber called - checking horizontal position');
	const visibleLocation = getVisibleLocation();
	
	if (visibleLocation) {
		console.log('Found location element:', visibleLocation);
		console.log('Location text:', visibleLocation.textContent.trim());
		console.log('Location dataset:', visibleLocation.dataset);
		console.log('Location data-whatsapp attribute:', visibleLocation.getAttribute('data-whatsapp'));
		
		// Get horizontal position info
		const rect = visibleLocation.getBoundingClientRect();
		const elementCenterX = rect.left + (rect.width / 2);
		const viewportCenterX = window.innerWidth / 2;
		const distanceFromCenter = Math.abs(elementCenterX - viewportCenterX);
		
		console.log('Horizontal positioning - Element center X:', elementCenterX.toFixed(1), 'Viewport center X:', viewportCenterX.toFixed(1), 'Distance from center:', distanceFromCenter.toFixed(1));
		
		if (visibleLocation.dataset.whatsapp && visibleLocation.dataset.whatsapp.trim() !== '') {
			const oldNumber = number;
			number = visibleLocation.dataset.whatsapp;
			console.log('Updated WhatsApp number from', oldNumber, 'to:', number, 'for location:', visibleLocation.textContent.trim());
			console.log('Location selected based on horizontal position (closest to viewport center)');
			
			// Also visually select this location
			setActiveLocation(visibleLocation);
			
			// Update cart location display
			updateCartLocation(visibleLocation);
			
			// Debug verification - show the switch happened
			verifyWhatsAppSwitch(oldNumber, number, visibleLocation.textContent.trim());
		} else {
			console.log('No WhatsApp number found in dataset for location:', visibleLocation.textContent.trim());
			console.log('Raw data-whatsapp attribute value:', visibleLocation.getAttribute('data-whatsapp'));
		}
	} else {
		console.log('No visible location found - check if locations container exists');
	}
}

// Function to verify and debug WhatsApp number switch
function verifyWhatsAppSwitch(oldNumber, newNumber, locationName) {
	console.log('üîç VERIFICATION: WhatsApp number switch detected!');
	console.log('üìç Location:', locationName);
	console.log('üì± Old number:', oldNumber);
	console.log('üì± New number:', newNumber);
	console.log('‚úÖ Switch successful:', oldNumber !== newNumber);
	
	// Also verify the global number variable was updated
	console.log('üåê Global number variable:', number);
	console.log('üîó Verification:', number === newNumber ? 'PASSED' : 'FAILED');
	
	// Show what will be used in WhatsApp messages
	console.log('üì§ Next WhatsApp message will use:', number);
}

// Function to get the currently visible location
function getVisibleLocation() {
	const locationElements = document.querySelectorAll('li.locations .locbtn');
	
	if (locationElements.length === 0) {
		console.log('No location elements found');
		return null;
	}
	
	// Use horizontal coordinates since locations are arranged horizontally
	let bestElement = null;
	let bestScore = -Infinity;
	const viewportCenterX = window.innerWidth / 2;
	
	for (let i = 0; i < locationElements.length; i++) {
		const element = locationElements[i];
		const rect = element.getBoundingClientRect();
		const elementCenterX = rect.left + (rect.width / 2);
		
		// Calculate distance from viewport center (closer = higher score)
		const distanceFromCenter = Math.abs(elementCenterX - viewportCenterX);
		const score = 1000 - distanceFromCenter; // Higher score for closer to center
		
		console.log(`Location ${i + 1}: "${element.textContent.trim()}" - Score: ${score}, Center X: ${elementCenterX.toFixed(1)}, Viewport Center X: ${viewportCenterX.toFixed(1)}`);
		
		if (score > bestScore) {
			bestScore = score;
			bestElement = element;
		}
	}
	
	console.log('Best location element:', bestElement?.textContent.trim(), 'with score:', bestScore);
	return bestElement;
}
const messageStart = 'Powered by TTMenus\n'+name+'\nHello, Good Day\nI would like to order the following\n\nORDER\n';
let messageBody = '';
const messageEnd = '\nThank You!\nLooking forward to confirming this order';

let modes =  [ 	{'name':'takeaway'},{'name':'dinein'}];
let currentMode = 'dinein'; 

let orderSize = '';
let orderFlav = '';

let order = [];
let basePrice = 0;

let orderSides = [];
let sidePrice = 0;
let regAmt=0;
let premAmt=0;

let orderAdd = [];
let addPrice = 0;

let orderMod = [];
let modPrice = 0;

let vat = {{ site.Params.orderingsystem.vat }};
let vatcost = 0;

let service = {{ site.Params.orderingsystem.servicecharge }};
let servicecost = 0;

let price = 0;

let myTable='';

let currentoptions;

let sizePrice=0;

function showShop(){
	document.getElementById("orderModal").classList.remove('order-hidden');
	document.body.classList.add('modal-open');
}
function closeShop(){
	document.getElementById("orderModal").classList.add('order-hidden');
	var cart = document.getElementById("cart");
  var footerBtns = document.getElementById("footerBtns");
  cart.classList.add('cart-hidden');
  footerBtns.classList.add('grad2');
  footerBtns.classList.remove('grad1');
  footerBtns.classList.remove('bigfont');
  footerBtns.classList.add('smallfont');
	var addbtn = document.getElementById("addicon");
	var modbtn = document.getElementById("modicon");
	orderSides=[];
  orderAdd=[];
	orderMod=[];
	regAmt=0;
	premAmt=0;
	//console.log(orderMod);
}
function openItem(ele,options){
	addFocus(ele);
	console.log("openShop");
	showShop();
	regAmt=0;
	premAmt=0;
	sidePrice=0;
	addPrice=0;
	modPrice=0;
	currentoptions=options;
	document.getElementById("itemAmt").innerText=(1);
	document.getElementById("sideList").innerText='';
	document.getElementById("modList").innerText='';
	document.getElementById("addModList").innerText='';

	document.getElementById("itemCategory").innerText=(options.category);
	const currentPageName = document.title;
	if (!currentPageName.startsWith(options.category)) { 
		document.getElementById("itemCategory").setAttribute('href',options.categoryurl); 
		document.getElementById("itemImages").setAttribute('href',options.url);
	}else{
		document.getElementById("itemCategory").setAttribute('href','#'); 
		document.getElementById("itemImages").setAttribute('href','#');
	}

	document.getElementById("addicon").innerText = "{{ site.Params.orderingmenu.sidesname | default "Sides" }}";
	
	document.getElementById("itemName").innerText=(options.name);
	if (!currentPageName.startsWith(options.name)) { 
		document.getElementById("itemName").setAttribute('href',options.url); 
		document.getElementById("itemImages").setAttribute('href',options.url);
	}else{
		document.getElementById("itemName").setAttribute('href','#'); 
		document.getElementById("itemImages").setAttribute('href','#');
	}
	document.getElementById("itemDesc").innerHTML=(options.desc);
	


	if(options.images.length>0){
		var imgHtml = '';
		for (var i = 0; i<=options.images.length - 1;  i++) {
			imgHtml = imgHtml+'<img src="/'+options.images[i]+'">';
		}
		document.getElementById("itemImages").innerHTML=imgHtml;

	}else{
		document.getElementById("itemImages").innerHTML='<img src="/branding/favicon-400x200.webp">';
	}
	
	//Size Options
	var sizeHtml = '';
	for (var i = 0; i<=options.sizes.length - 1;  i++) {
					if(i==0){
			if(options.sizes[i]=='-'){
				sizeHtml = sizeHtml+'<a onclick="'+'setBaseSize(this);"'+' class="btn-size-option hide select">'+options.sizes[i]+'</a>';
			}else{
				sizeHtml = sizeHtml+'<a onclick="'+'setBaseSize(this);"'+' class="btn-size-option select">'+options.sizes[i]+'</a>';
			}
		}else{
			sizeHtml = sizeHtml+'<a onclick="'+'setBaseSize(this);"'+' class="btn-size-option">'+options.sizes[i]+'</a>';
		}
	}
	document.getElementById("itemSizeControl").innerHTML=sizeHtml;
	setBaseSize(document.getElementById("itemSizeControl").childNodes[0]);

//Flavours Options
	var flavoursHtml = '';
	for (var i = 0; i<=options.flavours.length - 1;  i++) {
					if(i==0){
			if(options.flavours[i]=='-'){
				flavoursHtml = flavoursHtml+'<a onclick=" setBaseFlav(this);'+'" class="btn-flavour-option hide select">'+options.flavours[i]+'</a>';
			}else{
				flavoursHtml = flavoursHtml+'<a onclick=" setBaseFlav(this);'+'" class="select">'+options.flavours[i]+'</a>';
			}
		}else{
			flavoursHtml = flavoursHtml+'<a onclick=" setBaseFlav(this);'+'" class="btn-flavour-option">'+options.flavours[i]+'</a>';
		}
	}
	document.getElementById("itemFlavourControl").innerHTML=flavoursHtml;
	setBaseFlav(document.getElementById("itemFlavourControl").childNodes[0]);

	//Sides Options
	var sideHtml = '';
	if(options.sides.length>0){
		makeSidesHtml(sideHtml,0);
	} else {
		document.getElementById("itemSideContainer").classList.add("hide");
	}
	
	//Additional Options
	var additionsHtml = '';
	if(options.additions.length>0){
		makeAdditionsHtml(additionsHtml,0);
	} else {
		document.getElementById("itemAddContainer").classList.add("hide");
	}
	
	//Mods Options
	var modificationsHtml = '';
	if(options.modifications.length>0){
		makeModificationsHtml(modificationsHtml,0);
	} else {
		document.getElementById("itemModContainer").classList.add("hide");
	}
	
	orderSides=[];
	orderAdd=[];
	orderMod=[];
	updatePrices();
}

function makeModificationsHtml(modificationsHtml,index) {
	console.log(index+' modificationsHtml:- '+modificationsHtml);
	if(currentoptions.modifications.length>index){
		console.log(currentoptions.modifications.length+'>'+index);
		modificationsHtml = modificationsHtml+'<a class="btn-mod-option" onclick="selectToggle(this);ModPrice(this,'+currentoptions.modifications[index+1]+');">'+currentoptions.modifications[index]+'</a><b class="hide">$'+currentoptions.modifications[index+1]+'</b>'
		makeModificationsHtml(modificationsHtml,index+2);
	} else {
		document.getElementById("itemMods").innerHTML='<h3 class="title center main-text-color">Modifications</h3><div>'+modificationsHtml+'</div><button class="btn-close-menu" onclick="openModMenu();"><i class="fa fa-times"></i> Close</button>';
		document.getElementById("itemModContainer").classList.remove("hide");
	}

}

function makeAdditionsHtml(additionsHtml,index) {
	console.log(index+' additionsHtml:- '+additionsHtml);
	if(currentoptions.additions.length>index){
		console.log(currentoptions.sides.length+'>'+index);
		additionsHtml = additionsHtml+'<a class="btn-add-option" onclick="selectToggle(this);AddPrice(this,'+currentoptions.additions[index+1]+');'+'">'+currentoptions.additions[index]+'</a><b class="hide">$'+currentoptions.additions[index+1]+'</b>'
		makeAdditionsHtml(additionsHtml,index+2);
	} else {
		document.getElementById("itemAddMods").innerHTML ='<h3 class="title center main-text-color">Additional Modifications</h3><div>'+additionsHtml+'</div><button class="btn-close-menu" onclick="openAddMenu();"><i class="fa fa-times"></i> Close</button>';
		document.getElementById("itemAddContainer").classList.remove("hide");
	}

}

function makeSidesHtml(sideHtml,index) {
	console.log(index+' Sides HTML:- '+sideHtml);
	if(currentoptions.sides.length>index){
		console.log(currentoptions.sides.length+'>'+index);
		if(currentoptions.sides[index+1]=='Regular'){
			sideHtml = sideHtml+'<b class="hide">1</b><a class="btn-side-option regularside" onclick="selectAmt(this);">'+currentoptions.sides[index]+'</a><p class="btn-add-extra hide" onclick="addExtra(this);"><i class="fa fa-plus"></i></p>';
		}else if(currentoptions.sides[index+1]=='Premium'){
			sideHtml = sideHtml+'<b class="hide">1</b><a class="btn-side-option premiumside" onclick="selectAmt(this);">'+currentoptions.sides[index]+' <i class="fa fa-star"></i></a><p class="btn-add-extra" onclick="addExtra(this);" class="hide"><i class="fa fa-plus"></i></p>';	
		}
		makeSidesHtml(sideHtml,index+3);
	} else {
		document.getElementById("itemSides").innerHTML='<h3 class="title center main-text-color">Sides</h3><div>'+sideHtml+'</div><button class="btn-close-menu" onclick="openSideMenu();"><i class="fa fa-times"></i> Close</button>';
		document.getElementById("itemSideContainer").classList.remove("hide");
	}

}

function addSides(ele){
	if (ele.classList.contains('select')){
		// console.log("ADD SIDE: "+ele.previousSibling.innerText+" "+ele.innerText);
		orderSides.push(ele.previousSibling.innerText+" "+ele.innerText);
		if(ele.classList.contains('regularside')){
			regAmt=regAmt+1;
			if(regAmt>=currentoptions.sideoptions[4]){
				sidePrice=sidePrice+currentoptions.sideoptions[5];
			}
		}else if(ele.classList.contains('premiumside')){
			premAmt=premAmt+1;
			if(premAmt>=currentoptions.sideoptions[7]){
				sidePrice=sidePrice+currentoptions.sideoptions[8];
			}
		}

	}
	// console.log(orderSides);
	updatePrices();
}

function removeSides(ele){
	if (ele.classList.contains('select')){
		if(ele.classList.contains('regularside')){
			if(regAmt>=currentoptions.sideoptions[4]){
				sidePrice=sidePrice-currentoptions.sideoptions[5];
			}
			regAmt=regAmt-parseInt(ele.previousSibling.innerText);

		}else if(ele.classList.contains('premiumside')){
			if(premAmt>=currentoptions.sideoptions[7]){
				sidePrice=sidePrice-currentoptions.sideoptions[8];
			}
			premAmt=premAmt-parseInt(ele.previousSibling.innerText);
		}
		// console.log("REMOVE SIDE: "+ele.previousSibling.innerText+" "+ele.innerText);
		var index = orderSides.indexOf(ele.previousSibling.innerText+" "+ele.innerText);
		orderSides.splice(index,1);
		ele.classList.remove('select');
		ele.previousSibling.classList.add('hide')
		ele.previousSibling.innerText=1;
	 	ele.nextSibling.classList.add('hide')
	 	
	}
	// console.log(orderSides);
	updatePrices();
}

function addExtra(ele){
	var selEle = ele.parentElement.getElementsByClassName('select');
	var num = 0;
		for (var i = 0; i<=selEle.length - 1;  i++) {
			num = num + parseInt(selEle[i].previousSibling.innerText);
		}
		if(num<currentoptions.sideoptions[0]){
			if(selEle.length<(currentoptions.sideoptions[0]) && parseInt(ele.previousSibling.previousSibling.innerText)<(currentoptions.sideoptions[0])){
				// console.log(orderSides);
				// console.log("SPLICE: "+(ele.previousSibling.previousSibling.innerText+" "+ele.previousSibling.innerText));
				var index = orderSides.indexOf(ele.previousSibling.previousSibling.innerText+" "+ele.previousSibling.innerText);
				orderSides.splice(index,1);
				// console.log(orderSides);
				ele.previousSibling.previousSibling.innerText=parseInt(ele.previousSibling.previousSibling.innerText)+1;
				addSides(ele.previousSibling);
			}
		}

}

function AddPrice(ele,i){
	if (ele.classList.contains('select')){
		addPrice = addPrice+i;

		orderAdd.push(ele.innerText);
	}else{
		addPrice = addPrice-i;
		var index = orderAdd.indexOf(ele.innerText);
		orderAdd.splice(index,1);
	}
	if(addPrice<0){
		addPrice = 0;
	}
	//console.log("AddPrice");
	updatePrices();
}

function ModPrice(ele,i){
	if (ele.classList.contains('select')){
		modPrice = modPrice+i;
		orderMod.push(ele.innerText);
		ele.nextSibling.classList.remove('hide');
	}else{
		modPrice = modPrice-i;
		var index = orderMod.indexOf(ele.innerText);
		orderMod.splice(index,1);
		ele.nextSibling.classList.add('hide');
	}
	//console.log("ModPrice");
	updatePrices();
}

function lineCostCalc(ele,i){
	var linecost=0;
	if(ele.classList.contains('select')){
		linecost = +i;
	}else{
		linecost = -i;
	}
	document.getElementById("itemPrice").innerText=('$'+(basePrice+addPrice+modPrice));
	//console.log("lineCostCalc");
	updatePrices();
}

function itemAmtCalc(value){
	var myAmt = document.getElementById("itemAmt");
	var newValue = parseInt(myAmt.innerText);
	newValue=newValue + value;
	if(newValue>0){
		myAmt.innerText = newValue;	
	}
	//console.log("itemAmtCalc");
	updatePrices();
}


function setBasePrice(index){
	if(currentoptions.items.length>index){
		if(currentoptions.items[index]==orderSize){
			console.log("CurrentSize :"+ orderSize+"|"+ currentoptions.items[index])

			if(currentoptions.items[index+1]==orderFlav){
				console.log("Current Flav :"+ orderFlav +"|"+currentoptions.items[index+1])
				basePrice=currentoptions.items[index+2];
				return;
			}else{
				console.log("!No Match Flav:"+ orderFlav +"|"+currentoptions.items[index+1])
				index=index+3;
				setBasePrice(index);
			}

		}else{
			console.log("!No Match Size:"+orderSize+"|"+currentoptions.items[index])
			index=index+3;
			setBasePrice(index);
		}

	}
	updatePrices();
}

function setBaseSize(ele){
	orderSize = ele.innerText;
	// console.log("setVaseSize :"+orderSize);
	selectOnly(ele);
	setBasePrice(0);
	updatePrices();
}

function setBaseFlav(ele){
	orderFlav = ele.innerText;
	// console.log("setBaseFlav :"+orderFlav);
	selectOnly(ele);
	setBasePrice(0);
	updatePrices();
}

function updatePrices(){
	document.getElementById("itemPrice").innerText=('$'+(basePrice+sidePrice+addPrice+modPrice));
	document.getElementById("itemAddCart").innerHTML=('<i class="fa fa-cart-plus"></i> '+(basePrice+sidePrice+addPrice+modPrice));

	var lineCost = parseInt(document.getElementById("itemAmt").innerText)*(basePrice+sidePrice+addPrice+modPrice);
	document.getElementById("itemAddCart").innerHTML=('<i class="fa fa-cart-plus"></i> $'+lineCost);

	var funcText = 'addItem("'+document.getElementById("itemName").innerText+'","'+orderSize+' '+orderFlav+'","'+orderSides+'","'+orderAdd+'","'+orderMod+'","'+document.getElementById("itemAmt").innerText+'",'+lineCost+');';
	document.getElementById("itemAddCart").setAttribute( "onclick", funcText);

	//console.log(funcText);
	//console.log(orderMod);
}

function addFocus(ele){
 	var selEle = document.getElementsByClassName('selected');
 	for (var i = selEle.length - 1; i >= 0; i--) {
 		selEle[i].classList.remove('selected');
 	}
 	ele.classList.add('selected');
}

function selectOnly(ele){
	if(!ele.classList.contains('select')){
		var selEle = ele.parentElement.getElementsByClassName('select')
	 	for (var i = selEle.length - 1; i >= 0; i--) {
	 		selEle[i].classList.remove('select');
	 	}
		ele.classList.add('select');
	}
}

function selectToggle(ele){
	if(ele.classList.contains('select')){
		ele.classList.remove('select');
	}else{
		ele.classList.add('select');
		//add text to order
	}
	return ele.classList.contains('select');
}

function selectAmt(ele){
	if(ele.classList.contains('select')){
		removeSides(ele);
	}else{
		var selEle = ele.parentElement.getElementsByClassName('select');
		var num = 0;
		for (var i = 0; i<=selEle.length - 1;  i++) {
			num = num + parseInt(selEle[i].previousSibling.innerText);
		}
		if (num<currentoptions.sideoptions[0] && selEle.length<currentoptions.sideoptions[0]){
					num = num+1;
					ele.classList.add('select');
					addSides(ele);
		 			ele.previousSibling.classList.remove('hide');
		 			ele.nextSibling.classList.remove('hide');
		}
	}	
}

function itemAmtCalc(value){
	var myAmt = document.getElementById("itemAmt");
	var newValue = parseInt(myAmt.innerText);
	newValue=newValue + value;
	if(newValue>0){
		myAmt.innerText = newValue;	
	}
	//console.log("itemAmtCalc");
	updatePrices();
}


// CART

function toggleCart(){
    var cart = document.getElementById("cart");
    var footerBtns = document.getElementById("footerBtns");
    if(cart.classList.contains('cart-hidden')){
      cart.classList.remove('cart-hidden');
      footerBtns.classList.add('bigfont');
      footerBtns.classList.add('cartopen');
      footerBtns.classList.remove('smallfont');
      footerBtns.classList.add('grad1');
      footerBtns.classList.remove('grad2');
    }else{
      cart.classList.add('cart-hidden');
      footerBtns.classList.remove('cartopen');
      footerBtns.classList.add('grad2');
      footerBtns.classList.remove('grad1');
      footerBtns.classList.remove('bigfont');
      footerBtns.classList.add('smallfont');
      
    }
  }
  function closeCart(){
    var cart = document.getElementById("cart");
    var footerBtns = document.getElementById("footerBtns");
    cart.classList.add('cart-hidden');
    footerBtns.classList.remove('cartopen');
    footerBtns.classList.add('grad2');
    footerBtns.classList.remove('grad1');
    footerBtns.classList.remove('bigfont');
    footerBtns.classList.add('smallfont');
	}

	function saveCart() {
		const baseURL = window.location.origin;
		localStorage.setItem('menu', JSON.stringify(baseURL));
	  localStorage.setItem('cart', JSON.stringify(order));
	  console.log(localStorage.getItem('cart'));
	}

	function loadCart() {
		const savedMenu = localStorage.getItem('menu');
		const baseURL = window.location.origin;
		if (savedMenu == JSON.stringify(baseURL) ){
		  const savedCart = localStorage.getItem('cart');
		  if (savedCart) {
		    order = JSON.parse(savedCart);
		    console.log(order);
		    buildOrderText(); // Refresh the cart UI with the loaded data
		  }
	  }
	}

  function addItem(item,size,sides,adds,mods,amt,cost){
  order.push({"item":item,"size":size,"sides":sides,"adds":adds, "mods":mods, "amt":amt,"cost":cost});
  additemtocart();
  cartadditem();
  buildOrderText();
  saveCart();
  updateCart(1);
  //openCart();
  //printValues();
}
function additemtocart(){
  let modal = document.getElementById("orderModal");
  modal.classList.add("additemtocart");
  setTimeout(()=>{
  			closeShop();
        modal.classList.remove("additemtocart");
  },             500);  
   
} 
function cartadditem(){
  let cart = document.getElementById("carticon");
  cart.classList.add("cartadditem");
  setTimeout(()=>{
        cart.classList.remove("cartadditem");
  },             500);  
   
} 
function removeItem(i){
	order.splice(i,1);
	buildOrderText();
	saveCart();
	updateCart(-1);
	//printValues();
}
function removeAllItems(){
	order=[];
	var c =order.index-1;
	order=[];
	localStorage.removeItem('cart');  // Clear cart from localStorage
	buildOrderText();
	document.getElementById("cartcount").innerText= 0;
  updateCart(0);
	//printValues();
}

function updateCart(i){
    var cart = document.getElementById("cartcount");
    cart.innerText= parseInt(cart.innerText)+i;
    
    if(parseInt(cart.innerText)<=0){
    	cart.classList.add('hide');
    }else{
    	cart.classList.remove('hide');
    }
}

function buildOrderText(){
	messageBody='';
	var itemSides='';
	var itemAdds='';
	var itemMods='';
	var orderHtml='<tr><th id="itemNo">#</th><th>Size</th><th>Item</th><th>Amt</th><th>Cost</th><th style="text-align: center;"><a style="font-size: medium;" onclick="removeAllItems();"><i class="fa fa-trash-o"></i></a></th></tr>';

	for (var i = 0; i <= order.length-1; i++) {
		
		if (order[i].sides.length>0){
			itemSides = 'Sides:';
			for (var j = 0; j <= order[i].sides.length-1; j++) {
			 itemSides=itemSides+order[i].sides[j];
			}
		}

		if (order[i].adds.length>0){
			itemAdds = 'Additional Mods:';
			for (var j = 0; j <= order[i].adds.length-1; j++) {
			 itemAdds=itemAdds+order[i].adds[j];

			}
		}

		if (order[i].mods.length>0){
			itemMods = 'Mods:';
			for (var j = 0; j <= order[i].mods.length-1; j++) {
			 	itemMods=itemMods+order[i].mods[j];
			}
		}

		messageBody=messageBody+'#'+(i+1)+' | '+order[i].size+' '+order[i].item+' | Qty'+order[i].amt+' $'+order[i].cost+printArraySides(i,itemSides)+printArrayMods(i,itemMods)+printArrayAdds(i,itemAdds)+'\n\n';

		//CUSTOM MESSAGE BODY
		//messageBody='#'+messageBody+(i+1)+' | '+'Qty'+order[i].amt+' | '+order[i].size+' '+order[i].item+' $'+order[i].cost+printArraySides(i,itemSides)+printArrayAdds(i,itemAdds)+printArrayMods(i,itemMods)+'\n';
		orderHtml = (orderHtml+'<tr><td id="itemNo">'+(i+1)+'</td><td id="itemSize">'+order[i].size+'</td><td id="itemDesc">'+order[i].item+printHtmlArraySides(i,itemSides)+printHtmlArrayMods(i,itemMods)+printHtmlArrayAdds(i,itemAdds)+'\n'+'</td><td>'+order[i].amt+' </td><th id="itemCost">$'+order[i].cost+'</th><td id="itemXBtn"><a onclick="removeItem('+i+');"><i class="fa fa-close"></i></a></td></tr>');
		// console.log(orderHtml);
		itemAdds=[];
		itemMods=[];
		orderSides=[];
	}

	priceCalc();
	vatCalc();
	serviceCalc();
	document.getElementById("whatsappOrder").innerHTML=orderHtml;
	if(vat>0 || service>0){
		document.getElementById("subTotal").innerText=(price.toFixed(2));
		document.getElementById("subTotalcontainer").classList.remove('hide');
		
	}else {
		document.getElementById("subTotalcontainer").classList.add('hide');
	}
	if(vat>0){
			document.getElementById("vat").innerText=('V.A.T. '+vat*100+'% $');
			document.getElementById("vatCalc").innerText=(vatcost.toFixed(2));
			document.getElementById("vatCalccontainer").classList.remove('hide');
	}else{
		document.getElementById("vatCalccontainer").classList.add('hide');
	}
	if(service>0){
		document.getElementById("service").innerText=('Service Charge '+service*100+'% $');
		document.getElementById("serviceCalc").innerText=(servicecost.toFixed(2));
		document.getElementById("serviceCalccontainer").classList.remove('hide');
	}else{
		document.getElementById("serviceCalccontainer").classList.add('hide');
	}
	var displayTotal=(price+vatcost+servicecost);
	document.getElementById("itemTotal").innerText=('TOTAL $'+displayTotal.toFixed(2));
	constructWAMessage();
}

function openSideMenu() {
	var list = document.getElementById("sideList");
  var con = document.getElementById("itemSideControl");
  list.innerText=printArray(orderSides);
     if(con.classList.contains('hide')){
      con.classList.remove('hide');
    }else{
      con.classList.add('hide');
    }
}

function openAddMenu() {
	var list = document.getElementById("addModList");
  var con = document.getElementById("itemAdditionControl");
  list.innerText=printArray(orderAdd);
     if(con.classList.contains('hide')){
      con.classList.remove('hide');
    }else{
      con.classList.add('hide');
    }
}

function openModMenu() {
	var list = document.getElementById("modList");
  var con = document.getElementById("itemModControl");
  list.innerText=printArray(orderMod);
     if(con.classList.contains('hide')){
      con.classList.remove('hide');
    }else{
      con.classList.add('hide');
    }
}

function printArray(arr){
 	var mod = '';
 	for (var j = 0; j <= arr.length-1; j++) {
			 	mod=mod+'- '+arr[j]+'\n';
			}
	return mod;
 }

function printHtmlArraySides(i,itemSides){
	if (order[i].sides.length>0){
		return ('<br>'+itemSides);
	}else return '';
}
function printHtmlArrayAdds(i,itemAdds){
	if (order[i].adds.length>0){
		return ('<br>'+itemAdds);
	}else return '';
}
function printHtmlArrayMods(i,itemMods){
	if (order[i].mods.length>0){
		return ('<br>'+itemMods);
	}else return '';
}

function printArraySides(i,itemSides){
	if (order[i].sides.length>0){
		return ('\n'+itemSides);
	}else return '';
}

function printArrayAdds(i,itemAdds){
	if (order[i].adds.length>0){
		return ('\n'+itemAdds);
	}else return '';
}

function printArrayMods(i,itemMods){
	if (order[i].mods.length>0){
		return ('\n'+itemMods);
	}else return '';
}

function priceCalc(){
	price = 0;
	for (var i = 0; i <= order.length-1; i++) {
		price=price+order[i].cost;
	}
}

function vatCalc(){
	vatcost=parseFloat((price*vat).toFixed(2));
}
function serviceCalc(){
	servicecost=parseFloat((price*service).toFixed(2));
}


function advanceOrder(){
	if (hastables) {
		// Close the cart first
		closeCart();
		
		// Get the currently selected location and pass it to the table modal
		const currentLocation = getVisibleLocation();
		if (currentLocation) {
			// Get the location data from the DOM element
			const locationData = getLocationDataFromElement(currentLocation);
			if (locationData) {
				openTableModalWithLocation(locationData);
			} else {
				// Fallback to default table modal
				openTableModal();
			}
		} else {
			// No location selected, show alert and fallback
			alert('Please select a location first before placing your order.');
			openTableModal();
		}
	}else{
		// Close the cart first
		closeCart();
		confirm();
	}
}

// Function to get location data from a DOM element
function getLocationDataFromElement(locationElement) {
	if (!locationElement) return null;
	
	// Try to get location data from the element's dataset or attributes
	const locationAddress = locationElement.textContent.trim();
	const locationWhatsApp = locationElement.dataset.whatsapp;
	const locationLat = locationElement.dataset.lat;
	const locationLng = locationElement.dataset.lng;
	const orderingTables = locationElement.dataset.orderingtables;
	
	console.log('üîç Extracting location data from element:', {
		address: locationAddress,
		whatsapp: locationWhatsApp,
		lat: locationLat,
		lng: locationLng,
		orderingTables: orderingTables
	});
	
	// If we have basic location info, create a location object
	if (locationAddress) {
		// Parse ordering tables if available
		let parsedOrderingTables = [];
		if (orderingTables && orderingTables.trim() !== '') {
			parsedOrderingTables = orderingTables.split(',').map(table => table.trim());
			console.log('üìã Parsed ordering tables:', parsedOrderingTables);
		} else {
			console.log('‚ö†Ô∏è No ordering tables found for location:', locationAddress);
		}
		
		const locationData = {
			address: locationAddress,
			whatsapp: locationWhatsApp,
			lat: locationLat,
			lng: locationLng,
			orderingtables: parsedOrderingTables
		};
		
		console.log('‚úÖ Final location data object:', locationData);
		return locationData;
	}
	
	return null;
}

// Function to open table modal with specific location data
function openTableModalWithLocation(locationData) {
    if (!locationData) {
        console.error('‚ùå No location data provided');
        return;
    }
    
    // Store the selected location data
    selectedLocationData = locationData;
    
    // Update the display with location info
    updateSelectedLocationDisplay(locationData);
    
    // Populate table numbers
    populateTableNumbers(locationData);
    
    // Show the table selection section
    const tableSelectionSection = document.getElementById('tableSelectionSection');
    if (tableSelectionSection) {
        tableSelectionSection.classList.add('show');
    }
    
    // Show the modal
    document.getElementById('tableNumberModal').classList.remove('hide');
}

// Function to set table number from external sources (like table modal)
function setTableNumber(tableNumber) {
	console.log('üéØ Setting table number to:', tableNumber);
	myTable = tableNumber;
	
	// Update the cart display if needed
	updateCartLocationDisplay();
}

// Function to update cart location display with table info
function updateCartLocationDisplay() {
	const cartLocationDiv = document.getElementById('cartLocation');
	if (cartLocationDiv) {
		const currentLocation = getVisibleLocation();
		if (currentLocation) {
			const locationText = currentLocation.textContent.trim();
			let displayText = `üìç ${locationText}`;
			
			// Add table number if available
			if (myTable && myTable.trim() !== '') {
				displayText += ` - Table ${myTable}`;
			}
			
			cartLocationDiv.innerHTML = displayText;
			cartLocationDiv.classList.add('active');
		}
	}
}

function confirm(){
	constructWAMessage();
	confirmSendOrder();
}

function constructWAMessage(){
	var subTotalTxt='';
	var vatTxt='';
	var servicext='';
	var label='';
	
	// Determine the correct label based on global order type variables
	if (currentOrderType === 'takeaway') {
		label = 'Takeaway';
	} else if (currentOrderType === 'table' && currentTableNumber && currentTableNumber.trim() !== '') {
		label = `Table #${currentTableNumber}`;
	} else {
		label = 'Takeaway'; // Default fallback
	}
	
	if(vat>0 || service>0){
		subTotalTxt='\nSub Total $ '+price.toFixed(2);
		if(vat>0){
			vatTxt='\nV.A.T. '+vat*100+'% $ '+vatcost.toFixed(2);
		}
		if(service>0){
			servicext='\nService Charge '+service*100+'% $ '+servicecost.toFixed(2);
		}
	}
	
	message = 'https://wa.me/'+number+'?text='+encodeURIComponent(messageStart+label+'\n'+messageBody+subTotalTxt+vatTxt+servicext+'\nTOTAL $'+(price+vatcost+servicecost)+messageEnd);
}

function confirmSendOrder(){
	window.open(message, "_blank" );
	
	// Clear the order type variables after sending the order
	currentOrderType = 'takeaway';
	currentTableNumber = '';
}

//Dine modes
function toggleDiningMode(ele){
  if (ele.checked == true){
    selectMode(1);
   
  } else{
    selectMode(0);
    
  }
}
function selectMode(i){
  currentMode = modes[i].name;
  //var checkBox1 = document.getElementById("dining-mode-checkbox-1");
  var checkBox2 = document.getElementById("dining-mode-checkbox-2");
  if(i==1){
  	//checkBox1.checked=true;
  	checkBox2.checked=true;
  	service=0.0;
  }else{
  	//checkBox1.checked=false;
  	checkBox2.checked=false;
  	myTable='';
  	service=0.0;
  }
  //console.log(modes[i].name);
  executeMode();
  buildOrderText();
}


function executeMode(){
	var cart=document.getElementById('cart')
	//cart.classList.remove('cartexpanded');
	//document.getElementById('titleRow').innerHTML='<i class="fa fa-arrow-right"></i> '+currentMode; 
	var server=document.getElementById('askforserver');
	if (currentMode=='dinein'){
		server.classList.remove("hide");
	}else{
		server.classList.add("hide");
	}
  // var ele = document.getElementsByClassName('takeawayonly');
  
  // if (currentMode==modes[0].name){
  //   document.getElementById('takeaway').classList.add('active');
  //   document.getElementById('dinein').classList.remove('active');
  //   // for (var i = ele.length - 1; i >= 0; i--) {
  //   //   ele[i].classList.remove('hide');
  //   // }
  // }else{
  //   // for (var i = ele.length - 1; i >= 0; i--) {
  //   //   ele[i].classList.add('hide');
  //   // }
  //   document.getElementById('dinein').classList.add('active');
  //   document.getElementById('takeaway').classList.remove('active');
  // }
  
 }

function executeModeOnModal(){
  
  // if (currentMode=='dinein'){
  //   var ele = document.getElementById('itemSizeControl').getElementsByTagName("a");
  //   for (var i = ele.length - 1; i >= 0; i--) {
  //     if(ele[i].innerText.substring(0, 1)=="S"){
  //         ele[i].classList.add('hide');
  //         ele[i].classList.remove('select');
  //     }else{
  //         selectOnly(ele[i]);
  //         setBaseSize(ele[i]);
  //     }

  //   }
  // }
}

function executeModeOnTableModal(){	
	var ele1 = document.getElementsByClassName('tableBtn');
	var ele2 = document.getElementsByClassName('takeawayBtn');
	if (currentMode=='takeaway'){
		ele2[0].classList.remove('hide');
		ele2[0].classList.remove('select');
		for (var i = ele1.length - 1; i >= 0; i--) {
     		ele1[i].classList.add('hide');
          	ele1[i].classList.remove('select');
        }
	}else if (currentMode=='dinein'){
		ele2[0].classList.add('hide'); 
		ele2[0].classList.remove('select');   	
		for (var i = ele1.length - 1; i >= 0; i--) {
     		ele1[i].classList.remove('select');
          	ele1[i].classList.remove('hide');
        }
	}
}

function cartSizeToggle(){
	 var cart=document.getElementById('cart')
	 if (cart.classList.contains('cartexpanded')){
	 	cart.classList.remove('cartexpanded');
	 	document.getElementById('titleRow').innerHTML='<i class="fa fa-arrow-right"></i> Order';
	 }else{
	 	cart.classList.add('cartexpanded');
	 	document.getElementById('titleRow').innerHTML='<i class="fa fa-arrow-down"></i> Order';
	 }
}	

function openTableModal(state){
	closeCart();
	if (state=='askforserver'){
		document.getElementById("tableNumberModal").classList.remove('hide');
		document.getElementById("confirmmodal").classList.add('hide');
		document.getElementById("askforservermodal").classList.remove('hide');
		//executeModeOnTableModal();
	}else if (currentMode=='takeaway'){
		confirm();
		return;
	}else{
		document.getElementById("tableNumberModal").classList.remove('hide');
		document.getElementById("askforservermodal").classList.add('hide');
		document.getElementById("confirmmodal").classList.remove('hide');
		//executeModeOnTableModal();
	}
	
}
function closeTableModal() {
    document.getElementById('tableNumberModal').classList.add('hide');
    document.getElementById('confirmmodal').classList.remove('show');
    document.querySelector('.input').classList.remove('hide');
    
    // Hide the table selection section
    const tableSelectionSection = document.getElementById('tableSelectionSection');
    if (tableSelectionSection) {
        tableSelectionSection.classList.remove('show');
    }
    
    // Remove selected class from all table buttons
    const allTableButtons = document.querySelectorAll('.tableBtn');
    allTableButtons.forEach(btn => btn.classList.remove('selected'));
    
    // Hide the order summary display
    const orderSummaryDisplay = document.getElementById('orderSummaryDisplay');
    if (orderSummaryDisplay) {
        orderSummaryDisplay.classList.add('hide');
    }
    
    // Clear the order summary display
    const summaryLocationInfo = document.getElementById('summaryLocationInfo');
    if (summaryLocationInfo) {
        summaryLocationInfo.innerHTML = '';
    }
    
    // Reset selected table info
    window.selectedTableInfo = null;
    selectedLocationData = null;
    
    // Clear the current order location
    window.currentOrderLocation = null;
}

// Enhanced selectTable function to include location context
function selectTable(buttonElement) {
    if (!selectedLocationData) {
        console.error('‚ùå No location data available for table selection');
        alert('Please select a location first');
        return;
    }
    
    // Remove selected class from all table buttons
    const allTableButtons = document.querySelectorAll('.tableBtn');
    allTableButtons.forEach(btn => btn.classList.remove('selected'));
    
    // Add selected class to the clicked button
    buttonElement.classList.add('selected');
    
    const tableNumber = buttonElement.textContent;
    const isTakeaway = buttonElement.classList.contains('takeaway-btn');
    
    // Store selected table info
    window.selectedTableInfo = {
        tableNumber: tableNumber,
        isTakeaway: isTakeaway,
        location: selectedLocationData
    };
    
    // Set global order type variables for WhatsApp message
    currentOrderType = isTakeaway ? 'takeaway' : 'table';
    currentTableNumber = tableNumber;
    
    // Update the modal to show confirmation
    const tableNumElement = document.getElementById('myTableNum');
    if (tableNumElement) {
        if (isTakeaway) {
            tableNumElement.textContent = 'Ready to place your takeaway order?';
        } else {
            tableNumElement.textContent = `Table: ${tableNumber} at ${selectedLocationData.address}`;
        }
    }
    
    if (isTakeaway) {
        // For takeaway, update the summary display and go to order confirmation
        updateOrderSummary(selectedLocationData);
        // Show the summary for takeaway orders
        document.getElementById('orderSummaryDisplay').classList.remove('hide');
    } else {
        // For table orders, hide the summary
        document.getElementById('orderSummaryDisplay').classList.add('hide');
    }
    
    // Show the confirmation modal
    document.getElementById('confirmmodal').classList.add('show');
}

function confirmTable(state){
	if(myTable!=''){
		// if(	myTable.endsWith('2L')||myTable.endsWith('14R')){
		// 	number="";
		// }else if(	myTable.endsWith('1')||myTable.endsWith('18R')){
		// 	number="";
		// }else if(	myTable.endsWith('2')||myTable.endsWith('8L')){
		// 	number="";
		// }
		if (state=='askforserver'){
			askforserver();
		}else{
			confirm();
		}
		
	}
}

function askforserver(){
	message = 'https://wa.me/'+number+'?text='+encodeURIComponent('Powered by TTMenus\n'+name+'\n\nHello, Good Day\n'+'Server Requested at Table# '+myTable);
	confirmSendOrder();
}

// Function to find closest location, scroll to it, and select it
function findClosestLocation() {
	console.log('üîç Finding closest location...');
	
	// Check if geolocation is supported
	if (!navigator.geolocation) {
		console.log('‚ùå Geolocation not supported');
		alert('Geolocation is not supported by this browser. Please manually select a location.');
		return;
	}
	
	console.log('‚úÖ Geolocation supported, requesting permission...');
	
	// Show loading state
	const closestBtn = document.querySelector('a[onclick*="findClosestLocation"]');
	const originalText = closestBtn.innerHTML;
	closestBtn.innerHTML = 'üìç Finding...';
	closestBtn.style.opacity = '0.7';
	
	// Get user's current position with better error handling
	navigator.geolocation.getCurrentPosition(
		function(position) {
			console.log('‚úÖ Location permission granted!');
			const userLat = position.coords.latitude;
			const userLng = position.coords.longitude;
			console.log('üìç User location:', userLat, userLng);
			
			// Find closest location
			const locationElements = document.querySelectorAll('.locations .location-item .locbtn');
			let closestLocation = null;
			let shortestDistance = Infinity;
			
			console.log(`üîç Checking ${locationElements.length} locations...`);
			
			locationElements.forEach((location, index) => {
				const lat = parseFloat(location.dataset.lat);
				const lng = parseFloat(location.dataset.lng);
				
				if (!isNaN(lat) && !isNaN(lng)) {
					// Calculate distance using Haversine formula
					const distance = calculateDistance(userLat, userLng, lat, lng);
					console.log(`Location ${index + 1}: ${location.textContent.trim()} - Distance: ${distance.toFixed(2)} km`);
					
					if (distance < shortestDistance) {
						shortestDistance = distance;
						closestLocation = location;
					}
				} else {
					console.log(`‚ö†Ô∏è Location ${index + 1}: Invalid coordinates - lat: ${lat}, lng: ${lng}`);
				}
			});
			
			if (closestLocation) {
				console.log('üéØ Closest location found:', closestLocation.textContent.trim(), `(${shortestDistance.toFixed(2)} km)`);
				
				// Scroll to the closest location
				scrollToLocation(closestLocation);
				
				// Select it as the active location
				setActiveLocation(closestLocation);
				
				// Show success message
				closestBtn.innerHTML = '‚úÖ Found!';
				closestBtn.style.color = '#4CAF50';
				setTimeout(() => {
					closestBtn.innerHTML = originalText;
					closestBtn.style.opacity = '1';
					closestBtn.style.color = '#4CAF50';
				}, 2000);
				
			} else {
				console.log('‚ùå No valid locations found');
				alert('Could not find any valid locations. Please check your data.');
				closestBtn.innerHTML = originalText;
				closestBtn.style.opacity = '1';
			}
		},
		function(error) {
			console.log('‚ùå Error getting location:', error);
			console.log('Error code:', error.code);
			console.log('Error message:', error.message);
			
			let errorMessage = 'Could not get your location. ';
			switch(error.code) {
				case error.PERMISSION_DENIED:
					errorMessage += 'Location permission was denied. Please allow location access in your browser settings and try again.';
					break;
				case error.POSITION_UNAVAILABLE:
					errorMessage += 'Location information is unavailable. Please try again.';
					break;
				case error.TIMEOUT:
					errorMessage += 'Location request timed out. Please try again.';
					break;
				default:
					errorMessage += 'An unknown error occurred. Please try again.';
			}
			
			alert(errorMessage);
			closestBtn.innerHTML = originalText;
			closestBtn.style.opacity = '1';
		},
		{
			enableHighAccuracy: true,
			timeout: 15000, // Increased timeout to 15 seconds
			maximumAge: 60000
		}
	);
}

// Function to calculate distance between two coordinates using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
	const R = 6371; // Radius of the Earth in kilometers
	const dLat = (lat2 - lat1) * Math.PI / 180;
	const dLon = (lon2 - lon1) * Math.PI / 180;
	const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
		Math.sin(dLon/2) * Math.sin(dLon/2);
	const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
	return R * c;
}

// Function to scroll to a specific location
function scrollToLocation(locationElement) {
	console.log('üéØ Scrolling to location:', locationElement.textContent.trim());
	
	// Find the scrollable container (could be .locations or its parent)
	const locationItem = locationElement.closest('.location-item');
	const locationsContainer = document.querySelector('.locations');
	
	if (!locationItem || !locationsContainer) {
		console.log('‚ùå Could not find location item or container');
		return;
	}
	
	console.log('üìç Location item found:', locationItem);
	console.log('üì¶ Container found:', locationsContainer);
	
	// Get the scrollable parent (the one with horizontal scroll)
	let scrollableContainer = locationsContainer;
	while (scrollableContainer && !scrollableContainer.scrollWidth > scrollableContainer.clientWidth) {
		scrollableContainer = scrollableContainer.parentElement;
	}
	
	if (!scrollableContainer || scrollableContainer.scrollWidth <= scrollableContainer.clientWidth) {
		console.log('‚ùå No scrollable container found');
		return;
	}
	
	console.log('üîÑ Scrollable container:', scrollableContainer);
	console.log('üìè Container scroll width:', scrollableContainer.scrollWidth, 'client width:', scrollableContainer.clientWidth);
	
	// Method 1: Use scrollIntoView with horizontal centering
	try {
		console.log('üîÑ Method 1: Using scrollIntoView');
		locationItem.scrollIntoView({
			behavior: 'smooth',
			block: 'nearest',
			inline: 'center'
		});
		
		// Wait a bit then verify the scroll position
		setTimeout(() => {
			const finalRect = locationItem.getBoundingClientRect();
			const containerRect = scrollableContainer.getBoundingClientRect();
			const isCentered = Math.abs((finalRect.left + finalRect.width/2) - (containerRect.left + containerRect.width/2)) < 50;
			
			console.log('‚úÖ Scroll completed');
			console.log('üìç Final position - Left:', finalRect.left, 'Center:', finalRect.left + finalRect.width/2);
			console.log('üì¶ Container center:', containerRect.left + containerRect.width/2);
			console.log('üéØ Centered:', isCentered ? 'YES' : 'NO');
			
			if (!isCentered) {
				console.log('‚ö†Ô∏è Not perfectly centered, trying manual adjustment...');
				// Manual adjustment if needed
				const adjustment = (finalRect.left + finalRect.width/2) - (containerRect.left + containerRect.width/2);
				scrollableContainer.scrollBy({
					left: -adjustment,
					behavior: 'smooth'
				});
			}
		}, 500);
		
	} catch (error) {
		console.log('‚ùå scrollIntoView failed:', error);
		
		// Method 2: Manual scroll calculation as fallback
		console.log('üîÑ Method 2: Manual scroll calculation');
		
		const containerRect = scrollableContainer.getBoundingClientRect();
		const itemRect = locationItem.getBoundingClientRect();
		
		// Calculate the current scroll position needed
		const currentScrollLeft = scrollableContainer.scrollLeft;
		const itemOffsetLeft = locationItem.offsetLeft;
		const containerWidth = scrollableContainer.clientWidth;
		const itemWidth = locationItem.offsetWidth;
		
		// Calculate target scroll position to center the item
		const targetScrollLeft = itemOffsetLeft - (containerWidth / 2) + (itemWidth / 2);
		
		console.log('üìä Scroll calculations:');
		console.log('  Current scroll left:', currentScrollLeft);
		console.log('  Item offset left:', itemOffsetLeft);
		console.log('  Container width:', containerWidth);
		console.log('  Item width:', itemWidth);
		console.log('  Target scroll left:', targetScrollLeft);
		
		// Smooth scroll to the target position
		scrollableContainer.scrollTo({
			left: targetScrollLeft,
			behavior: 'smooth'
		});
		
		// Verify scroll position after completion
		setTimeout(() => {
			const finalScrollLeft = scrollableContainer.scrollLeft;
			const scrollDiff = Math.abs(finalScrollLeft - targetScrollLeft);
			console.log('‚úÖ Manual scroll completed');
			console.log('üìè Final scroll left:', finalScrollLeft);
			console.log('üéØ Scroll accuracy:', scrollDiff < 10 ? 'PERFECT' : 'CLOSE');
		}, 500);
	}
}

// Function to manually set active location
function setActiveLocation(locationElement) {
	if (locationElement && locationElement.dataset.whatsapp) {
		const oldNumber = number;
		number = locationElement.dataset.whatsapp;
		console.log('üéØ MANUAL: Set active location to:', locationElement.textContent.trim());
		console.log('üì± WhatsApp number changed from', oldNumber, 'to:', number);
		
		// Update visual state - remove active class from all location items
		document.querySelectorAll('.location-item').forEach(item => {
			item.classList.remove('active-location');
		});
		
		// Add active class to the selected location item
		locationElement.closest('.location-item').classList.add('active-location');
		
		// Update cart location display immediately
		updateCartLocation(locationElement);
		
		// Also update the global current order location for table modal
		if (locationElement.dataset.orderingtables) {
			window.currentOrderLocation = {
				address: locationElement.textContent.trim(),
				whatsapp: locationElement.dataset.whatsapp,
				lat: locationElement.dataset.lat,
				lng: locationElement.dataset.lng,
				orderingtables: locationElement.dataset.orderingtables.split(',').map(table => table.trim())
			};
			console.log('‚úÖ Updated currentOrderLocation for table modal:', window.currentOrderLocation);
		}
		
		// Verify the switch happened
		verifyWhatsAppSwitch(oldNumber, number, locationElement.textContent.trim());
	}
}

// Function to search locations based on user input
function searchLocations(searchTerm) {
	console.log('üîç Searching for:', searchTerm);
	
	const searchInput = document.getElementById('locationSearch');
	const locationItems = document.querySelectorAll('.locations .location-item');
	
	if (!searchTerm || searchTerm.trim() === '') {
		// Show all locations when search is empty
		locationItems.forEach(item => {
			item.style.display = 'flex';
			item.style.opacity = '1';
			item.style.transform = 'scale(1)';
		});
		
		// Remove any search highlighting
		document.querySelectorAll('.location-item .locbtn').forEach(btn => {
			btn.style.backgroundColor = '';
			btn.style.color = '';
			btn.style.fontWeight = '';
		});
		
		console.log('‚úÖ Showing all locations');
		return;
	}
	
	const searchLower = searchTerm.toLowerCase().trim();
	let foundCount = 0;
	
	locationItems.forEach(item => {
		const locationText = item.querySelector('.locbtn').textContent.toLowerCase();
		const isMatch = locationText.includes(searchLower);
		
		if (isMatch) {
			// Show and highlight matching locations
			item.style.display = 'flex';
			item.style.opacity = '1';
			item.style.transform = 'scale(1.02)';
			
			// Highlight the matching text
			const btn = item.querySelector('.locbtn');
			btn.style.backgroundColor = '#4CAF50';
			btn.style.color = 'white';
			btn.style.fontWeight = 'bold';
			
			foundCount++;
			console.log('‚úÖ Match found:', item.querySelector('.locbtn').textContent.trim());
		} else {
			// Hide non-matching locations
			item.style.display = 'none';
		}
	});
	
	console.log(`üîç Search complete: ${foundCount} location(s) found`);
	
	// Show search results count
	if (searchInput) {
		const currentPlaceholder = searchInput.placeholder;
		if (foundCount > 0) {
			searchInput.style.borderColor = '#4CAF50';
			searchInput.placeholder = `Found ${foundCount} location(s)`;
		} else {
			searchInput.style.borderColor = '#f44336';
			searchInput.placeholder = 'No locations found';
		}
		
		// Reset placeholder after 3 seconds
		setTimeout(() => {
			searchInput.placeholder = currentPlaceholder;
			searchInput.style.borderColor = '#ddd';
		}, 3000);
	}
}

// Function to clear search and show all locations
function clearLocationSearch() {
	const searchInput = document.getElementById('locationSearch');
	if (searchInput) {
		searchInput.value = '';
		searchLocations(''); // This will show all locations
	}
}

// Function to update the cart location display
function updateCartLocation(locationElement) {
	const cartLocationDiv = document.getElementById('cartLocation');
	if (cartLocationDiv && locationElement) {
		const locationText = locationElement.textContent.trim();
		cartLocationDiv.innerHTML = `üìç ${locationText}`;
		cartLocationDiv.classList.add('active');
		console.log('üõí Cart location updated to:', locationText);
	} else if (cartLocationDiv) {
		cartLocationDiv.innerHTML = 'üìç Select a location';
		cartLocationDiv.classList.remove('active');
		console.log('üõí Cart location reset to default');
	}
}

// Function to update search placeholder with location count
function updateSearchPlaceholder() {
	const searchInput = document.getElementById('locationSearch');
	const totalLocations = document.querySelectorAll('.locations .location-item').length;
	
	if (searchInput && totalLocations > 0) {
		searchInput.placeholder = `Search ${totalLocations} locations...`;
		console.log('üîç Updated search placeholder to show', totalLocations, 'locations');
	} else if (searchInput) {
		// Fallback if no locations found
		searchInput.placeholder = 'Search locations...';
		console.log('‚ö†Ô∏è No locations found, using fallback placeholder');
	}
}

// Function to navigate locations using arrow buttons
function scrollLocations(direction) {
	const locationsContainer = document.querySelector('.locations');
	if (!locationsContainer) {
		console.log('‚ùå Locations container not found');
		return;
	}
	
	const currentScrollLeft = locationsContainer.scrollLeft;
	const containerWidth = locationsContainer.clientWidth;
	const scrollAmount = containerWidth * 0.8; // Scroll 80% of container width
	
	let newScrollLeft;
	if (direction === 'left') {
		newScrollLeft = currentScrollLeft - scrollAmount;
		console.log('‚¨ÖÔ∏è Scrolling left from', currentScrollLeft, 'to', newScrollLeft);
	} else if (direction === 'right') {
		newScrollLeft = currentScrollLeft + scrollAmount;
		console.log('‚û°Ô∏è Scrolling right from', currentScrollLeft, 'to', newScrollLeft);
	} else {
		console.log('‚ùå Invalid direction:', direction);
		return;
	}
	
	// Smooth scroll to the new position
	locationsContainer.scrollTo({
		left: newScrollLeft,
		behavior: 'smooth'
	});
	
	// Update WhatsApp number after scrolling
	setTimeout(() => {
		updateWhatsAppNumber();
	}, 300); // Small delay to allow scroll to complete
}

// Function to toggle delivery options visibility
function toggleDelivery(button) {
	const deliveryOptions = button.nextElementSibling;
	if (deliveryOptions && deliveryOptions.classList.contains('delivery-options')) {
		deliveryOptions.classList.toggle('hide');
		
		// Update button text to show current state
		const buttonText = button.querySelector('span');
		if (buttonText) {
			if (deliveryOptions.classList.contains('hide')) {
				buttonText.textContent = 'Delivery';
			} else {
				buttonText.textContent = 'Hide';
			}
		}
		
		console.log('üõµ Delivery options toggled for location');
	} else {
		console.log('‚ùå Delivery options container not found');
	}
}


document.addEventListener("DOMContentLoaded", function() {
  requestAnimationFrame(() => { // Ensures DOM is ready before applying scroll
    loadCart();  // Load saved cart from localStorage
    updateCart(order.length);
    updateSearchPlaceholder(); // Call this function when the page loads
    
    // Initial update of WhatsApp number
    updateWhatsAppNumber();
    
    // Add scroll listener to update WhatsApp number when scrolling
    window.addEventListener('scroll', function() {
      // Only handle horizontal scrolling for location detection
      // Vertical scrolling should not affect location selection
      if (!window.scrollTimeout) {
        window.scrollTimeout = setTimeout(function() {
          // Only update if there's significant horizontal movement
          const currentScrollLeft = document.querySelector('.locations')?.scrollLeft || 0;
          if (window.lastScrollLeft !== undefined && Math.abs(currentScrollLeft - window.lastScrollLeft) > 10) {
            updateWhatsAppNumber();
          }
          window.lastScrollLeft = currentScrollLeft;
          window.scrollTimeout = null;
        }, 100);
      }
    });
    
    // Add scroll listener specifically to the locations container for better detection
    const locationsContainer = document.querySelector('.locations');
    if (locationsContainer) {
      locationsContainer.addEventListener('scroll', function() {
        // Update WhatsApp number immediately when scrolling horizontally within locations
        updateWhatsAppNumber();
      });
      
      // Add click event handlers for immediate location selection
      const locationButtons = document.querySelectorAll('li.locations .locbtn');
      locationButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          console.log('üìç Location clicked:', this.textContent.trim());
          // Immediately select this location
          setActiveLocation(this);
          // Update WhatsApp number immediately
          updateWhatsAppNumber();
        });
      });
      
      // Also add intersection observer for more precise detection
      const locationObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            // When a location becomes visible, update the WhatsApp number and visual selection
            setTimeout(updateWhatsAppNumber, 50); // Small delay to ensure DOM is updated
          }
        });
      }, {
        threshold: 0.5, // Trigger when 50% of the element is visible
        rootMargin: '0px -20% 0px -20%' // Consider element visible when it's 20% from left/right edges
      });
      
      // Observe all location buttons
      locationButtons.forEach(function(button) {
        locationObserver.observe(button);
      });
    }
    
    // Add manual trigger for testing
    window.testWhatsAppUpdate = function() {
      console.log('üîß Manual test triggered');
      console.log('üì± Current WhatsApp number before update:', number);
      updateWhatsAppNumber();
      console.log('üì± Current WhatsApp number after update:', number);
    };
    
    // Add debug function to show current state
    window.debugWhatsAppState = function() {
      console.log('üîç DEBUG: Current WhatsApp State');
      console.log('üì± Current number:', number);
      console.log('üìç Available locations:');
      const locationElements = document.querySelectorAll('li.locations .locbtn');
      locationElements.forEach((loc, index) => {
        console.log(`  ${index + 1}. ${loc.textContent.trim()} - WhatsApp: ${loc.dataset.whatsapp || 'NOT SET'}`);
      });
      console.log('üëÅÔ∏è Most visible location:', getVisibleLocation()?.textContent.trim() || 'None');
    };
    
    // Add function to test location detection
    window.testLocationDetection = function() {
      console.log('üß™ TESTING: Location Detection');
      const locationElements = document.querySelectorAll('li.locations .locbtn');
      console.log(`Found ${locationElements.length} location elements`);
      
      locationElements.forEach((loc, index) => {
        const rect = loc.getBoundingClientRect();
        console.log(`Location ${index + 1}: "${loc.textContent.trim()}"`);
        console.log(`  WhatsApp: ${loc.dataset.whatsapp || 'NOT SET'}`);
        console.log(`  Position: Left: ${rect.left}, Right: ${rect.right}, Center X: ${(rect.left + rect.width/2).toFixed(1)}`);
        console.log(`  Viewport Width: ${window.innerWidth}, Center X: ${(window.innerWidth/2).toFixed(1)}`);
        console.log(`  Is Visible: ${rect.left < window.innerWidth && rect.right > 0}`);
      });
      
      const visibleLocation = getVisibleLocation();
      console.log('Best visible location:', visibleLocation?.textContent.trim() || 'None');
    };
    
    // Add function to test geolocation
    window.testGeolocation = function() {
      console.log('üß™ TESTING: Geolocation');
      console.log('navigator.geolocation exists:', !!navigator.geolocation);
      
      if (navigator.geolocation) {
        console.log('‚úÖ Geolocation is supported');
        console.log('Requesting permission...');
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            console.log('‚úÖ SUCCESS: Location permission granted!');
            console.log('Coordinates:', position.coords.latitude, position.coords.longitude);
            console.log('Accuracy:', position.coords.accuracy, 'meters');
          },
          function(error) {
            console.log('‚ùå ERROR: Location permission denied or error occurred');
            console.log('Error code:', error.code);
            console.log('Error message:', error.message);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      } else {
        console.log('‚ùå Geolocation not supported');
      }
    };
    
    // Add function to test scrolling to specific locations
    window.testScrollToLocation = function(locationIndex = 0) {
      console.log('üß™ TESTING: Scroll to Location');
      const locationElements = document.querySelectorAll('.locations .location-item .locbtn');
      
      if (locationElements.length === 0) {
        console.log('‚ùå No location elements found');
        return;
      }
      
      const targetLocation = locationElements[locationIndex];
      if (!targetLocation) {
        console.log(`‚ùå Location at index ${locationIndex} not found`);
        console.log(`Available locations: 0 to ${locationElements.length - 1}`);
        return;
      }
      
      console.log(`üéØ Testing scroll to location ${locationIndex}:`, targetLocation.textContent.trim());
      console.log('üìç Current scroll position:', document.querySelector('.locations')?.scrollLeft || 'N/A');
      
      // Test the scroll function
      scrollToLocation(targetLocation);
    };
    
    // Add function to test all locations scrolling
    window.testAllLocationsScrolling = function() {
      console.log('üß™ TESTING: All Locations Scrolling');
      const locationElements = document.querySelectorAll('.locations .location-item .locbtn');
      
      if (locationElements.length === 0) {
        console.log('‚ùå No location elements found');
        return;
      }
      
      console.log(`üîç Found ${locationElements.length} locations`);
      
      // Test scrolling to each location with delays
      locationElements.forEach((location, index) => {
        setTimeout(() => {
          console.log(`\nüéØ Testing location ${index + 1}/${locationElements.length}:`, location.textContent.trim());
          scrollToLocation(location);
        }, index * 2000); // 2 second delay between each test
      });
    };
    
    // Add function to test location search
    window.testLocationSearch = function(searchTerm = 'Port') {
      console.log('üß™ TESTING: Location Search');
      console.log('Search term:', searchTerm);
      
      // Test the search function
      searchLocations(searchTerm);
      
      // Show current search state
      const searchInput = document.getElementById('locationSearch');
      if (searchInput) {
        console.log('üîç Search input value:', searchInput.value);
        console.log('üîç Search input placeholder:', searchInput.placeholder);
      }
      
      // Count visible locations
      const visibleLocations = document.querySelectorAll('.locations .location-item[style*="display: flex"]');
      const hiddenLocations = document.querySelectorAll('.locations .location-item[style*="display: none"]');
      
      console.log('üìç Visible locations:', visibleLocations.length);
      console.log('üö´ Hidden locations:', hiddenLocations.length);
      
      // Show visible location names
      visibleLocations.forEach((item, index) => {
        const text = item.querySelector('.locbtn').textContent.trim();
        console.log(`  ${index + 1}. ${text}`);
      });
    };
    
    // Add function to test cart location updates
    window.testCartLocation = function() {
      console.log('üß™ TESTING: Cart Location Updates');
      
      const cartLocationDiv = document.getElementById('cartLocation');
      if (cartLocationDiv) {
        console.log('‚úÖ Cart location div found');
        console.log('üìç Current cart location text:', cartLocationDiv.innerHTML);
        console.log('üé® Current cart location color:', cartLocationDiv.style.color);
      } else {
        console.log('‚ùå Cart location div not found');
      }
      
      // Test updating with a sample location
      const sampleLocation = document.querySelector('.locations .location-item .locbtn');
      if (sampleLocation) {
        console.log('üéØ Testing with sample location:', sampleLocation.textContent.trim());
        updateCartLocation(sampleLocation);
      } else {
        console.log('‚ùå No sample location found to test with');
      }
    };
    
    // Add function to test search placeholder updates
    window.testSearchPlaceholder = function() {
      console.log('üß™ TESTING: Search Placeholder');
      
      const searchInput = document.getElementById('locationSearch');
      if (searchInput) {
        console.log('‚úÖ Search input found');
        console.log('üîç Current placeholder:', searchInput.placeholder);
        console.log('üìç Total locations found:', document.querySelectorAll('.locations .location-item').length);
      } else {
        console.log('‚ùå Search input not found');
      }
      
      // Test updating the placeholder
      console.log('üß™ Testing placeholder update...');
      updateSearchPlaceholder();
      
      if (searchInput) {
        console.log('üîç New placeholder:', searchInput.placeholder);
      }
    };
    
    // Add function to test location navigation
    window.testLocationNavigation = function() {
      console.log('üß™ TESTING: Location Navigation');
      
      const leftBtn = document.getElementById('locationNavLeft');
      const rightBtn = document.getElementById('locationNavRight');
      const locationsContainer = document.querySelector('.locations');
      
      if (leftBtn && rightBtn) {
        console.log('‚úÖ Navigation buttons found');
        console.log('‚¨ÖÔ∏è Left button:', leftBtn);
        console.log('‚û°Ô∏è Right button:', rightBtn);
      } else {
        console.log('‚ùå Navigation buttons not found');
      }
      
      if (locationsContainer) {
        console.log('‚úÖ Locations container found');
        console.log('üìè Container width:', locationsContainer.clientWidth);
        console.log('üìè Scroll width:', locationsContainer.scrollWidth);
        console.log('üìç Current scroll left:', locationsContainer.scrollLeft);
        console.log('üîÑ Can scroll:', locationsContainer.scrollWidth > locationsContainer.clientWidth);
      } else {
        console.log('‚ùå Locations container not found');
      }
      
      // Test navigation functions
      console.log('üß™ Testing navigation functions...');
      console.log('‚¨ÖÔ∏è Left scroll function:', typeof scrollLocations);
      console.log('‚û°Ô∏è Right scroll function:', typeof scrollLocations);
    };
    
    // Add function to test delivery options
    window.testDeliveryOptions = function() {
      console.log('üß™ TESTING: Delivery Options');
      
      const deliveryButtons = document.querySelectorAll('.delivery-toggle-btn');
      const deliveryOptions = document.querySelectorAll('.delivery-options');
      
      console.log('üõµ Found delivery buttons:', deliveryButtons.length);
      console.log('üì¶ Found delivery options containers:', deliveryOptions.length);
      
      // Test each delivery button
      deliveryButtons.forEach((btn, index) => {
        const locationText = btn.closest('.location-item')?.querySelector('.locbtn')?.textContent.trim();
        const isHidden = btn.nextElementSibling?.classList.contains('hide');
        
        console.log(`Location ${index + 1}: "${locationText}" - Options hidden: ${isHidden}`);
        
        // Test toggle functionality
        console.log(`Testing toggle for location ${index + 1}...`);
        toggleDelivery(btn);
      });
      
      // Show current state
      setTimeout(() => {
        console.log('\nüìä Current delivery options state:');
        deliveryButtons.forEach((btn, index) => {
          const locationText = btn.closest('.location-item')?.querySelector('.locbtn')?.textContent.trim();
          const isHidden = btn.nextElementSibling?.classList.contains('hide');
          const buttonText = btn.querySelector('span')?.textContent;
          
          console.log(`Location ${index + 1}: "${locationText}" - Button: "${buttonText}", Hidden: ${isHidden}`);
        });
      }, 500);
    };
    
    // Add function to test locations data loading
    window.testLocationsData = function() {
      console.log('üß™ TESTING: Locations Data Loading');
      
      // Check if locations are in the DOM
      const locationItems = document.querySelectorAll('.locations .location-item');
      const locationButtons = document.querySelectorAll('.locations .locbtn');
      
      console.log('üìç Location items found:', locationItems.length);
      console.log('üîó Location buttons found:', locationButtons.length);
      
      if (locationItems.length > 0) {
        console.log('‚úÖ Locations are loaded in DOM');
        
        // Check each location's data
        locationItems.forEach((item, index) => {
          const btn = item.querySelector('.locbtn');
          if (btn) {
            console.log(`Location ${index + 1}:`);
            console.log(`  Address: ${btn.textContent.trim()}`);
            console.log(`  WhatsApp: ${btn.dataset.whatsapp || 'NOT SET'}`);
            console.log(`  Lat: ${btn.dataset.lat || 'NOT SET'}`);
            console.log(`  Lng: ${btn.dataset.lng || 'NOT SET'}`);
          }
        });
      } else {
        console.log('‚ùå No locations found in DOM');
        console.log('üîç Checking for debug comments in HTML...');
        
        // Look for debug comments
        const debugComments = document.querySelectorAll('html').length > 0 ? 
          'HTML structure found' : 'No HTML structure';
        console.log('üìÑ HTML Status:', debugComments);
      }
      
      // Check search functionality
      const searchInput = document.getElementById('locationSearch');
      if (searchInput) {
        console.log('üîç Search input found, placeholder:', searchInput.placeholder);
      } else {
        console.log('‚ùå Search input not found');
      }
    };
    
    // WhatsApp ordering system loaded. Use testWhatsAppUpdate() to test manually.
  });
});

// Make functions globally available for table modal integration
window.setTableNumber = setTableNumber;
window.confirm = confirm;
window.advanceOrder = advanceOrder;
window.openTableModalWithLocation = openTableModalWithLocation;
window.getLocationDataFromElement = getLocationDataFromElement;
window.updateCartLocationDisplay = updateCartLocationDisplay;

// Add debugging and testing functions
window.testTableModalIntegration = function() {
	console.log('üß™ TESTING: Table Modal Integration');
	console.log('üìç Current location:', getVisibleLocation()?.textContent.trim() || 'None');
	console.log('üì± Current WhatsApp number:', number);
	console.log('ü™ë Current table:', myTable);
	console.log('üõí Current order mode:', currentMode);
	console.log('üì¶ Cart items:', order.length);
	console.log('üåê Global functions available:', {
		setTableNumber: typeof window.setTableNumber,
		confirm: typeof window.confirm,
		advanceOrder: typeof window.advanceOrder,
		openTableModal: typeof window.openTableModal
	});
	
	// Test location data extraction
	const currentLocation = getVisibleLocation();
	if (currentLocation) {
		const locationData = getLocationDataFromElement(currentLocation);
		console.log('üîç Extracted location data:', locationData);
	} else {
		console.log('‚ùå No visible location found');
	}
};

window.testLocationDataAttributes = function() {
	console.log('üß™ TESTING: Location Data Attributes');
	
	const locationElements = document.querySelectorAll('li.locations .locbtn');
	console.log(`Found ${locationElements.length} location elements`);
	
	locationElements.forEach((element, index) => {
		console.log(`\nüìç Location ${index + 1}: "${element.textContent.trim()}"`);
		console.log('  Data attributes:');
		console.log('    data-whatsapp:', element.dataset.whatsapp || 'NOT SET');
		console.log('    data-lat:', element.dataset.lat || 'NOT SET');
		console.log('    data-lng:', element.dataset.lng || 'NOT SET');
		console.log('    data-orderingtables:', element.dataset.orderingtables || 'NOT SET');
		
		// Test data extraction
		const locationData = getLocationDataFromElement(element);
		if (locationData) {
			console.log('  ‚úÖ Data extraction successful:', locationData);
		} else {
			console.log('  ‚ùå Data extraction failed');
		}
	});
};

window.testTableSelection = function() {
	console.log('üß™ TESTING: Table Selection Process');
	
	// Simulate the complete flow
	const currentLocation = getVisibleLocation();
	if (currentLocation) {
		console.log('üéØ Testing with location:', currentLocation.textContent.trim());
		
		// Test location data extraction
		const locationData = getLocationDataFromElement(currentLocation);
		if (locationData) {
			console.log('‚úÖ Location data extracted successfully');
			
			// Test opening table modal
			console.log('üöÄ Opening table modal...');
			openTableModalWithLocation(locationData);
		} else {
			console.log('‚ùå Failed to extract location data');
		}
	} else {
		console.log('‚ùå No location selected, cannot test table selection');
	}
};

// WhatsApp ordering system loaded with table modal integration
// Available global functions: setTableNumber, confirm, advanceOrder
// Testing functions: testTableModalIntegration, testTableSelection, testLocationDataAttributes

// var lastScrollTop = 0;
// document.addEventListener("scroll", function(){ // or window.addEventListener("scroll"....
//    var st = window.pageYOffset || document.documentElement.scrollTop; // Credits: "https://github.com/qeremy/so/blob/master/so.dom.js#L426"
//    var footerBtns = document.getElementById("footerBtns");
//    //var accessibility = document.getElementById("accessibility");
//    var cart = document.getElementById("cart");
//    if (st > lastScrollTop ) {
//       footerBtns.classList.add('bigfont');
//       footerBtns.classList.add('grad1');
//       footerBtns.classList.remove('smallfont');
//       footerBtns.classList.remove('grad2');
//    } else if (st < lastScrollTop && !cart.classList.contains('hide')) {
//       footerBtns.classList.add('smallfont');
//       footerBtns.classList.add('grad2');
//       footerBtns.classList.remove('bigfont');
//       footerBtns.classList.remove('grad1');
//    } // else was horizontal scroll
//    lastScrollTop = st <= 0 ? 0 : st; // For Mobile or negative scrolling
// }, false);


function toggleTTMS(){
    var ttms = document.getElementById("ttmenusModal");
    var footerBtns = document.getElementById("footerBtns");
    if(ttms.classList.contains('cart-hidden')){
      ttms.classList.remove('cart-hidden');
      footerBtns.classList.add('bigfont');
      footerBtns.classList.remove('smallfont');
      footerBtns.classList.add('grad1');
      footerBtns.classList.remove('grad2');
    }else{
      ttms.classList.add('cart-hidden');
      footerBtns.classList.add('grad2');
      footerBtns.classList.remove('grad1');
      footerBtns.classList.remove('bigfont');
      footerBtns.classList.add('smallfont');
      
    }
  }
  function closeTTMS(){
    var ttms = document.getElementById("ttmenusModal");
    var footerBtns = document.getElementById("footerBtns");
    ttms.classList.add('cart-hidden');
    footerBtns.classList.add('grad2');
    footerBtns.classList.remove('grad1');
    footerBtns.classList.remove('bigfont');
    footerBtns.classList.add('smallfont');
	}

// ===== TABLE MODAL FUNCTIONS =====

// Global variable to store the selected location data
let selectedLocationData = null;

// Global variables to store order type information
let currentOrderType = 'takeaway'; // 'takeaway' or 'table'
let currentTableNumber = '';

// Function to populate table numbers based on selected location
function populateTableNumbers(locationData) {
    const tableButtonsContainer = document.getElementById('dynamicTableButtons');
    
    if (!locationData || !locationData.orderingtables) {
        // Fallback to default table numbers if no location data
        tableButtonsContainer.innerHTML = `
            <a class="tableBtn" href="#here" onclick="selectTable(this);">1</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">2</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">3</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">4</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">5</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">6</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">7</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">8</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">9</a>
            <a class="tableBtn" href="#here" onclick="selectTable(this);">10</a>
        `;
        return;
    }
    
    // Clear existing buttons
    tableButtonsContainer.innerHTML = '';
    
    // Process each ordering table option
    locationData.orderingtables.forEach((tableOption, index) => {
        if (tableOption === "Takeway Only") {
            // Add takeaway option
            const takeawayBtn = document.createElement('a');
            takeawayBtn.className = 'tableBtn takeaway-btn';
            takeawayBtn.href = '#here';
            takeawayBtn.onclick = function() { selectTable(this); };
            takeawayBtn.textContent = 'Takeaway';
            takeawayBtn.style.background = 'linear-gradient(#ff6b35, #f7931e)';
            tableButtonsContainer.appendChild(takeawayBtn);
        } else if (tableOption.startsWith('Tables')) {
            // Extract table numbers from "Tables1", "Tables2", etc.
            const tableNumber = tableOption.replace('Tables', '');
            const tableBtn = document.createElement('a');
            tableBtn.className = 'tableBtn';
            tableBtn.href = '#here';
            tableBtn.onclick = function() { selectTable(this); };
            tableBtn.textContent = tableNumber;
            tableButtonsContainer.appendChild(tableBtn);
        } else {
            // Handle other table options
            const tableBtn = document.createElement('a');
            tableBtn.className = 'tableBtn';
            tableBtn.href = '#here';
            tableBtn.onclick = function() { selectTable(this); };
            tableBtn.textContent = tableOption;
            tableButtonsContainer.appendChild(tableBtn);
        }
    });
}

// Function to open table modal with location data from WhatsApp ordering system
function openTableModal() {
    // Check if we have location data from the WhatsApp ordering system
    if (window.currentOrderLocation) {
        // Set the selected location data
        selectedLocationData = window.currentOrderLocation;
        
        // Update the location display
        updateSelectedLocationDisplay(window.currentOrderLocation);
        
        // Check if the location has ordering tables
        if (window.currentOrderLocation.orderingtables && window.currentOrderLocation.orderingtables.length > 0) {
            selectedLocationData = window.currentOrderLocation;
            populateTableNumbers(window.currentOrderLocation);
        } else {
            // Use fallback table numbers
            populateTableNumbers(null);
        }
        
        
    } else {
        alert('Please select a location first before placing your order.');
        return;
    }
    
    // Show the modal
    document.getElementById('tableNumberModal').classList.remove('hide');
    
    // Show table selection section immediately since we have location data
    document.getElementById('tableSelectionSection').classList.remove('hide');
}

// Function to update the selected location display
function updateSelectedLocationDisplay(locationData) {
    const locationDisplay = document.getElementById('selectedLocationDisplay');
    if (locationDisplay && locationData) {
        locationDisplay.innerHTML = `
            <div class="selected-location-info">
                <strong>üìç ${locationData.address}</strong>
                ${locationData.whatsapp ? `<br><small>üì± ${locationData.whatsapp}</small>` : ''}
                ${locationData.phone ? `<br><small>üìû ${locationData.phone}</small>` : ''}
            </div>
        `;
    }
}

// Function to update the order summary display for takeaway orders
function updateOrderSummary(locationData) {
    const summaryLocationInfo = document.getElementById('summaryLocationInfo');
    if (summaryLocationInfo && locationData) {
        summaryLocationInfo.innerHTML = `
            <div>${locationData.address}</div>
            ${locationData.whatsapp ? `<small>üì± ${locationData.whatsapp}</small>` : ''}
            ${locationData.phone ? `<small>üìû ${locationData.phone}</small>` : ''}
        `;
    }
}

// ===== TESTING FUNCTIONS =====

// Simple test function to manually test the table modal
window.testTableModalManually = function() {
    console.log('üß™ MANUAL TEST: Opening table modal with test data');
    
    const testLocationData = {
        address: 'Test Location - 123 Test Street',
        whatsapp: '+1234567890',
        lat: '40.7128',
        lng: '-74.0060',
        orderingtables: ['Takeway Only', 'Tables1', 'Tables2', 'Tables3']
    };
    
    console.log('üìç Test location data:', testLocationData);
    
    // Call the function directly
    openTableModalWithLocation(testLocationData);
};

// Simple function to just show the modal without data
window.showTableModal = function() {
    document.getElementById('tableNumberModal').classList.remove('hide');
    console.log('‚úÖ Table modal should now be visible');
};

// Test table modal functions
window.testTableModal = function() {
    console.log('üß™ TESTING: Table Modal Functions');
    console.log('üìç Selected location data:', selectedLocationData);
    console.log('üåê Current order location:', window.currentOrderLocation);
    console.log('üîß Functions available:', {
        populateTableNumbers: typeof populateTableNumbers,
        openTableModal: typeof openTableModal,
        openTableModalWithLocation: typeof openTableModalWithLocation,
        selectTable: typeof selectTable,
        closeTableModal: typeof closeTableModal,
        confirmTable: typeof confirmTable,
        updateSelectedLocationDisplay: typeof updateSelectedLocationDisplay
    });
    
    // Test location data
    if (window.currentOrderLocation) {
        console.log('üîç Testing location data...');
        console.log('‚úÖ Location data found:', window.currentOrderLocation);
        
        if (window.currentOrderLocation.orderingtables) {
            console.log('üìã Ordering tables available:', window.currentOrderLocation.orderingtables);
        }
    }
};

// Test table population
window.testTablePopulation = function() {
    console.log('üß™ TESTING: Table Population');
    
    if (selectedLocationData) {
        console.log('üìç Using selected location:', selectedLocationData);
        populateTableNumbers(selectedLocationData);
    } else if (window.currentOrderLocation) {
        console.log('üìç Using current order location:', window.currentOrderLocation);
        if (window.currentOrderLocation.orderingtables) {
            populateTableNumbers(window.currentOrderLocation);
        }
    } else {
        console.log('‚ùå No location data available for testing');
    }
};

    // Add function to test horizontal scrolling specifically
    window.testHorizontalScrolling = function() {
      console.log('üß™ TESTING: Horizontal Scrolling and Location Detection');
      
      const locationsContainer = document.querySelector('.locations');
      if (locationsContainer) {
        console.log('‚úÖ Locations container found');
        console.log('üìè Container scroll width:', locationsContainer.scrollWidth);
        console.log('üìè Container client width:', locationsContainer.clientWidth);
        console.log('üìç Current scroll left:', locationsContainer.scrollLeft);
        console.log('üîÑ Can scroll horizontally:', locationsContainer.scrollWidth > locationsContainer.clientWidth);
        
        // Test each location's horizontal position
        const locationButtons = document.querySelectorAll('li.locations .locbtn');
        console.log(`\nüîç Testing ${locationButtons.length} locations for horizontal positioning:`);
        
        locationButtons.forEach((btn, index) => {
          const rect = btn.getBoundingClientRect();
          const elementCenterX = rect.left + (rect.width / 2);
          const viewportCenterX = window.innerWidth / 2;
          const distanceFromCenter = Math.abs(elementCenterX - viewportCenterX);
          
          console.log(`Location ${index + 1}: "${btn.textContent.trim()}"`);
          console.log(`  Position: Left: ${rect.left.toFixed(1)}, Right: ${rect.right.toFixed(1)}`);
          console.log(`  Center X: ${elementCenterX.toFixed(1)}, Viewport Center: ${viewportCenterX.toFixed(1)}`);
          console.log(`  Distance from center: ${distanceFromCenter.toFixed(1)}`);
          console.log(`  WhatsApp: ${btn.dataset.whatsapp || 'NOT SET'}`);
        });
        
        // Test the current visible location
        const visibleLocation = getVisibleLocation();
        if (visibleLocation) {
          console.log(`\nüéØ Current best location: "${visibleLocation.textContent.trim()}"`);
          console.log(`üì± WhatsApp number: ${visibleLocation.dataset.whatsapp || 'NOT SET'}`);
        } else {
          console.log('\n‚ùå No visible location detected');
        }
        
      } else {
        console.log('‚ùå Locations container not found');
      }
    };
    
    // Add function to manually scroll to test horizontal positioning
    window.testHorizontalScroll = function(direction = 'right') {
      console.log(`üß™ TESTING: Manual horizontal scroll ${direction}`);
      
      const locationsContainer = document.querySelector('.locations');
      if (locationsContainer) {
        const currentScroll = locationsContainer.scrollLeft;
        const scrollAmount = locationsContainer.clientWidth * 0.8; // Scroll 80% of container width
        
        let newScroll;
        if (direction === 'left') {
          newScroll = Math.max(0, currentScroll - scrollAmount);
        } else {
          newScroll = Math.min(locationsContainer.scrollWidth - locationsContainer.clientWidth, currentScroll + scrollAmount);
        }
        
        console.log(`Scrolling from ${currentScroll} to ${newScroll}`);
        
        locationsContainer.scrollTo({
          left: newScroll,
          behavior: 'smooth'
        });
        
        // Check location after scroll
        setTimeout(() => {
          console.log('üìç Scroll completed, checking location...');
          updateWhatsAppNumber();
        }, 500);
        
      } else {
        console.log('‚ùå Locations container not found');
      }
    };
    
    // Add function to manually select a location by index for testing
    window.selectLocationByIndex = function(index = 0) {
      console.log(`üß™ TESTING: Manually selecting location at index ${index}`);
      
      const locationButtons = document.querySelectorAll('li.locations .locbtn');
      if (locationButtons.length === 0) {
        console.log('‚ùå No location buttons found');
        return;
      }
      
      if (index >= locationButtons.length) {
        console.log(`‚ùå Index ${index} is out of range. Available indices: 0 to ${locationButtons.length - 1}`);
        return;
      }
      
      const targetLocation = locationButtons[index];
      console.log(`üéØ Selecting location: "${targetLocation.textContent.trim()}"`);
      
      // Manually trigger the click event
      targetLocation.click();
      
      // Also manually call setActiveLocation for immediate effect
      setActiveLocation(targetLocation);
      
      console.log('‚úÖ Location selection completed');
    };
    
    // Add function to show all available locations
    window.showAllLocations = function() {
      console.log('üß™ TESTING: Show all available locations');
      
      const locationButtons = document.querySelectorAll('li.locations .locbtn');
      console.log(`Found ${locationButtons.length} locations:`);
      
      locationButtons.forEach((btn, index) => {
        console.log(`${index}: "${btn.textContent.trim()}" - WhatsApp: ${btn.dataset.whatsapp || 'NOT SET'}`);
      });
      
      console.log('\nUse selectLocationByIndex(index) to select a specific location');
    };

    // Function to close table modal
    function closeTableModal() {
        document.getElementById('tableNumberModal').classList.add('hide');
        document.getElementById('confirmmodal').classList.remove('show');
        document.querySelector('.input').classList.remove('hide');
        
        // Hide the table selection section
        const tableSelectionSection = document.getElementById('tableSelectionSection');
        if (tableSelectionSection) {
            tableSelectionSection.classList.remove('show');
        }
        
        // Remove selected class from all table buttons
        const allTableButtons = document.querySelectorAll('.tableBtn');
        allTableButtons.forEach(btn => btn.classList.remove('selected'));
        
        // Hide the order summary display
        const orderSummaryDisplay = document.getElementById('orderSummaryDisplay');
        if (orderSummaryDisplay) {
            orderSummaryDisplay.classList.add('hide');
        }
        
        // Clear the order summary display
        const summaryLocationInfo = document.getElementById('summaryLocationInfo');
        if (summaryLocationInfo) {
            summaryLocationInfo.innerHTML = '';
        }
        
        // Reset selected table info
        window.selectedTableInfo = null;
        selectedLocationData = null;
        
        // Clear the current order location
        window.currentOrderLocation = null;
        
        // NOTE: Do NOT clear currentOrderType and currentTableNumber here
        // They are needed for the WhatsApp message construction
    }

    // Function to confirm table selection
    function confirmTable(action) {
        if (!window.selectedTableInfo) {
            console.error('‚ùå No table selected');
            alert('No table selected. Please try again.');
            return;
        }
        
        const { tableNumber, isTakeaway, location } = window.selectedTableInfo;
        
        // Both table and takeaway orders go directly to WhatsApp order
        console.log(`üìã Placing order for ${isTakeaway ? 'takeaway' : 'table'} ${tableNumber} at location: ${location.address}`);
        
        // Set the table number in the WhatsApp ordering system
        if (typeof window.setTableNumber === 'function') {
            window.setTableNumber(tableNumber);
        } else {
            // Fallback: try to set the table number directly
            if (window.myTable !== undefined) {
                window.myTable = tableNumber;
            }
        }
        
        // Close the modal and proceed with order
        closeTableModal();
        
        // Trigger the order confirmation in the WhatsApp ordering system
        if (typeof window.confirm === 'function') {
            window.confirm();
        } else {
            console.error('‚ùå Confirm function not found');
        }
    }

    // ===== TESTING FUNCTIONS =====

    // Add function to test order type variables
    window.testOrderTypeVariables = function() {
    	console.log('üß™ TESTING: Order Type Variables');
    	console.log('üìç Current order type:', currentOrderType);
    	console.log('ü™ë Current table number:', currentTableNumber);
    	console.log('üì± Current WhatsApp number:', number);
    	console.log('üõí Current order mode:', currentMode);
    	console.log('üåê Global functions available:', {
    		setTableNumber: typeof window.setTableNumber,
    		confirm: typeof window.confirm,
    		advanceOrder: typeof window.advanceOrder
    	});
    	
    	// Test the message construction
    	console.log('üß™ Testing message construction...');
    	const testMessageStart = 'Powered by TTMenus\n'+name+'\nHello, Good Day\nI would like to order the following\n\nORDER\n';
    	const testMessageBody = '#1 | Test Item | Qty1 $10\n';
    	const testMessageEnd = '\nThank You!\nLooking forward to confirming this order';
    	
    	let testLabel = '';
    	if (currentOrderType === 'takeaway') {
    		testLabel = 'Takeaway';
    	} else if (currentOrderType === 'table' && currentTableNumber && currentTableNumber.trim() !== '') {
    		testLabel = `Table #${currentTableNumber}`;
    	} else {
    		testLabel = 'Takeaway'; // Default fallback
    	}
    	
    	const testMessage = testMessageStart + testLabel + '\n' + testMessageBody + testMessageEnd;
    	console.log('üìù Test message preview:');
    	console.log(testMessage);
    	console.log('‚úÖ Label used:', testLabel);
    };

    // WhatsApp ordering system loaded with table modal integration
</script>