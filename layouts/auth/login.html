<!DOCTYPE html>
<html lang="{{ site.Language.Lang }}">
<head>
  {{ partial "head.html" . }}
  <link rel="stylesheet" href="{{ site.BaseURL }}css/auth.css">
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <img src="{{ site.BaseURL }}branding/ttmenus.gif" alt="TTMenus Logo" class="auth-logo">
        <h1 class="auth-title">Welcome Back</h1>
        <p class="auth-subtitle">Sign in to access your dashboard</p>
      </div>

      <!-- Alert Messages -->
      <div id="alertContainer"></div>

      <!-- Login Form -->
      <form id="loginForm" class="auth-form" method="post" action="javascript:void(0);" onsubmit="return false;">
        <div class="form-group">
          <label for="email" class="form-label">Email Address</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            class="form-input" 
            placeholder="you@example.com"
            required
            autocomplete="email"
          >
          <div class="form-error" id="emailError"></div>
        </div>

        <div class="form-group">
          <label for="password" class="form-label">Password</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            class="form-input" 
            placeholder="Enter your password"
            required
            autocomplete="current-password"
          >
          <div class="form-error" id="passwordError"></div>
        </div>

        <div class="form-checkbox">
          <input type="checkbox" id="rememberMe" name="rememberMe">
          <label for="rememberMe">Remember me</label>
        </div>

        <button type="submit" class="btn-primary" id="loginBtn">
          Sign In
        </button>
      </form>

      <div class="auth-links">
        <a href="/forgot-password/" class="auth-link">Forgot your password?</a>
      </div>

      <div class="auth-divider">
        <span>Need access?</span>
      </div>

      <p style="text-align: center; color: #666; font-size: 14px; margin: 10px 0;">
        Contact your administrator to create an account for you.
      </p>

      <div class="auth-links" style="margin-top: 20px;">
        <a href="/" class="auth-link">‚Üê Back to Home</a>
      </div>
    </div>
  </div>

  <!-- Login Page Script -->
  <script>
    // Wait for AuthClient to be loaded
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const loginBtn = document.getElementById('loginBtn');
      const alertContainer = document.getElementById('alertContainer');

      // Check if already logged in
      if (AuthClient.isAuthenticated()) {
        // Redirect to content-management-service to create session
        const user = AuthClient.getCurrentUser();
        const token = AuthClient.getToken();
        const clientId = user?.client_id || '_ttms_menu_demo'; // Fallback to default
        
        if (token) {
          // Create session via POST request (secure, no token in URL)
          createCMSSession(clientId, token);
        } else {
          // Fallback: redirect directly to preview (will create session there)
          window.location.href = `https://cms.ttmenus.com/api/clients/${encodeURIComponent(clientId)}/preview`;
        }
        return;
      }

      // Handle form submission - prevent default form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Clear previous errors
        clearErrors();

        // Get form values
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        // Basic validation
        if (!email) {
          showError('emailError', 'Email is required');
          return;
        }

        if (!password) {
          showError('passwordError', 'Password is required');
          return;
        }

        // Show loading state
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span class="spinner"></span> Signing In...';

        try {
          // Log attempt for debugging
          console.log('üîê Attempting login...');
          console.log('üì° API URL:', AuthClient.config.apiUrl);
          
          // Attempt login
          const result = await AuthClient.login(email, password);
          console.log('üì• Login result:', result);

          if (result.success) {
            showAlert('success', 'Login successful! Redirecting...');
            
            // Verify user is authorized and redirect to content-management-service
            setTimeout(() => {
              const user = AuthClient.getCurrentUser();
              if (!user) {
                showAlert('error', 'Authentication failed. Please try again.');
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Sign In';
                return;
              }
              
              // Verify user has valid token
              const token = AuthClient.getToken();
              if (!token) {
                showAlert('error', 'Invalid authentication token. Please try again.');
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Sign In';
                return;
              }
              
              // Redirect to CMS service to create session
              const clientId = user?.client_id || '_ttms_menu_demo'; // Fallback to default
              
              if (token) {
                // Create session via POST request (secure, no token in URL)
                createCMSSession(clientId, token);
              } else {
                // Fallback: redirect directly to preview (will create session there)
                window.location.href = `https://cms.ttmenus.com/api/clients/${encodeURIComponent(clientId)}/preview`;
              }
            }, 1000);
          } else {
            console.error('‚ùå Login failed:', result.error);
            showAlert('error', result.error || 'Login failed. Please check your credentials.');
            loginBtn.disabled = false;
            loginBtn.innerHTML = 'Sign In';
          }
        } catch (error) {
          console.error('üí• Login exception:', error);
          
          // Provide more specific error messages
          let errorMessage = 'An unexpected error occurred. ';
          
          if (error.message === 'Failed to fetch' || error.message.includes('fetch')) {
            errorMessage = '‚ö†Ô∏è Cannot connect to authentication service. Please ensure the auth service is running on http://localhost:8080';
            console.error('üî¥ Auth service not reachable. Run: cd ttms-app-cluster/services/auth-service && go run cmd/main.go');
          } else if (error.message.includes('CORS')) {
            errorMessage = '‚ö†Ô∏è CORS error. Please check auth service CORS configuration.';
          } else if (error.message.includes('NetworkError')) {
            errorMessage = '‚ö†Ô∏è Network error. Please check your internet connection and auth service.';
          }
          
          showAlert('error', errorMessage);
          loginBtn.disabled = false;
          loginBtn.innerHTML = 'Sign In';
        }
      });

      // Helper functions
      function showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add('show');
          
          // Also add error class to input
          const inputId = elementId.replace('Error', '');
          const input = document.getElementById(inputId);
          if (input) {
            input.classList.add('error');
          }
        }
      }

      function clearErrors() {
        document.querySelectorAll('.form-error').forEach(el => {
          el.textContent = '';
          el.classList.remove('show');
        });
        document.querySelectorAll('.form-input').forEach(el => {
          el.classList.remove('error');
        });
      }

      function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
      }

      // Clear error on input
      emailInput.addEventListener('input', () => {
        emailInput.classList.remove('error');
        document.getElementById('emailError').classList.remove('show');
      });

      passwordInput.addEventListener('input', () => {
        passwordInput.classList.remove('error');
        document.getElementById('passwordError').classList.remove('show');
      });

      // Function to create CMS session securely via POST
      async function createCMSSession(clientId, token) {
        try {
          console.log('üîê Creating CMS session for client:', clientId);
          
          // Create session via POST to CMS API
          const response = await fetch(`https://cms.ttmenus.com/api/sessions`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            credentials: 'include', // Include cookies for cross-origin requests
            mode: 'cors', // Enable CORS
            body: JSON.stringify({
              client_id: clientId
            })
          });

          const responseData = await response.json();
          console.log('üì• CMS session response:', response.status, responseData);

          if (response.ok) {
            // Session created successfully, redirect to preview
            console.log('‚úÖ Session created, redirecting to preview...');
            window.location.href = `https://cms.ttmenus.com/api/clients/${encodeURIComponent(clientId)}/preview`;
          } else {
            // Fallback: try login-redirect endpoint (less secure but works)
            console.warn('‚ö†Ô∏è Session creation failed, using fallback redirect. Error:', responseData);
            // Still use fallback but log the issue
            window.location.href = `https://cms.ttmenus.com/login-redirect?client_id=${encodeURIComponent(clientId)}&token=${encodeURIComponent(token)}`;
          }
        } catch (error) {
          console.error('‚ùå Error creating CMS session:', error);
          // Fallback: redirect to login-redirect endpoint
          // Note: This puts token in URL which is less secure, but necessary for fallback
          window.location.href = `https://cms.ttmenus.com/login-redirect?client_id=${encodeURIComponent(clientId)}&token=${encodeURIComponent(token)}`;
        }
      }
    });
  </script>
</body>
</html>

