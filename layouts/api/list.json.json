{{- $menuItems := slice -}}

{{- range site.Sections -}}
  {{- if and (ne .Section "content") (ne .Section "advertisments") (ne .Section "tags") (ne .Section "categories") (ne .Section "subcategories") (ne .Section "types") (ne .Section "events") (ne .Section "ingredients") (ne .Section "cookingmethods") (ne .Section "admins") (ne .Section "admin") -}}
    
    {{- range .Pages -}}
      {{- /* Build sizes array */ -}}
      {{- $sizes := slice -}}
      {{- range .Params.prices -}}
        {{- if not (in $sizes .size) -}}
          {{- $sizes = $sizes | append .size -}}
        {{- end -}}
      {{- end -}}

      {{- /* Build flavours array */ -}}
      {{- $flavours := slice -}}
      {{- range .Params.prices -}}
        {{- if not (in $flavours .flavour) -}}
          {{- $flavours = $flavours | append .flavour -}}
        {{- end -}}
      {{- end -}}

      {{- /* Build prices array */ -}}
      {{- $prices := slice -}}
      {{- range .Params.prices -}}
        {{- $price := slice -}}
        {{- $price = $price | append .size -}}
        {{- $price = $price | append .flavour -}}
        {{- $price = $price | append .price -}}
        {{- $prices = $prices | append $price -}}
      {{- end -}}

      {{- /* Build side categories array (new structure) */ -}}
      {{- $sideCategories := slice -}}
      {{- if .Params.side_categories -}}
        {{- range .Params.side_categories -}}
          {{- $category := dict -}}
          {{- $category = merge $category (dict "category_name" .category_name) -}}
          {{- $category = merge $category (dict "display_name" .display_name) -}}
          
          {{- /* Build items for this category */ -}}
          {{- $items := slice -}}
          {{- range .items -}}
            {{- $item := slice -}}
            {{- $item = $item | append .name -}}
            {{- $item = $item | append .type -}}
            {{- $item = $item | append .price -}}
            {{- $items = $items | append $item -}}
          {{- end -}}
          {{- $category = merge $category (dict "items" $items) -}}
          
          {{- /* Build config for this category */ -}}
          {{- if .config -}}
            {{- $config := slice -}}
            {{- $config = $config | append .config.all_max -}}
            {{- $config = $config | append .config.all_valuecount -}}
            {{- $config = $config | append .config.all_value -}}
            {{- $config = $config | append .config.regular_max -}}
            {{- $config = $config | append .config.regular_valuecount -}}
            {{- $config = $config | append .config.regular_value -}}
            {{- $config = $config | append .config.premium_max -}}
            {{- $config = $config | append .config.premium_valuecount -}}
            {{- $config = $config | append .config.premium_value -}}
            {{- $category = merge $category (dict "config" $config) -}}
          {{- end -}}
          
          {{- $sideCategories = $sideCategories | append $category -}}
        {{- end -}}
      {{- end -}}
      
      {{- /* Build legacy sides array (for backward compatibility) */ -}}
      {{- $sides := slice -}}
      {{- range .Params.sides -}}
        {{- $side := slice -}}
        {{- $side = $side | append .name -}}
        {{- $side = $side | append .type -}}
        {{- $side = $side | append .price -}}
        {{- $sides = $sides | append $side -}}
      {{- end -}}

      {{- /* Build legacy side config array (for backward compatibility) */ -}}
      {{- $sideconfig := slice -}}
      {{- if .Params.side_config -}}
        {{- $config := slice -}}
        {{- $config = $config | append .Params.side_config.all_max -}}
        {{- $config = $config | append .Params.side_config.all_valuecount -}}
        {{- $config = $config | append .Params.side_config.all_value -}}
        {{- $config = $config | append .Params.side_config.regular_max -}}
        {{- $config = $config | append .Params.side_config.regular_valuecount -}}
        {{- $config = $config | append .Params.side_config.regular_value -}}
        {{- $config = $config | append .Params.side_config.premium_max -}}
        {{- $config = $config | append .Params.side_config.premium_valuecount -}}
        {{- $config = $config | append .Params.side_config.premium_value -}}
        {{- $sideconfig = $sideconfig | append $config -}}
      {{- end -}}

      {{- /* Build additions array */ -}}
      {{- $additions := slice -}}
      {{- range .Params.additions -}}
        {{- $addition := slice -}}
        {{- $addition = $addition | append .name -}}
        {{- $addition = $addition | append .price -}}
        {{- $additions = $additions | append $addition -}}
      {{- end -}}

      {{- /* Build modifications array */ -}}
      {{- $modifications := slice -}}
      {{- range .Params.modifications -}}
        {{- $modification := slice -}}
        {{- $modification = $modification | append .name -}}
        {{- $modification = $modification | append .price -}}
        {{- $modifications = $modifications | append $modification -}}
      {{- end -}}

      {{- /* Build images array */ -}}
      {{- $images := slice -}}
      {{- range .Params.images -}}
        {{- $images = $images | append .image -}}
      {{- end -}}

      {{- /* Build tags array */ -}}
      {{- $tags := slice -}}
      {{- with .Params.tags -}}
        {{- $tags = . -}}
      {{- end -}}
      
      {{- /* Build ingredients array */ -}}
      {{- $ingredients := slice -}}
      {{- with .Params.ingredients -}}
        {{- $ingredients = . -}}
      {{- end -}}
      
      {{- /* Build cooking methods array */ -}}
      {{- $cookingmethods := slice -}}
      {{- with .Params.cookingmethods -}}
        {{- $cookingmethods = . -}}
      {{- end -}}
      
      {{- /* Build types array */ -}}
      {{- $types := slice -}}
      {{- with .Params.types -}}
        {{- $types = . -}}
      {{- end -}}
      
      {{- /* Build events array */ -}}
      {{- $events := slice -}}
      {{- with .Params.events -}}
        {{- $events = . -}}
      {{- end -}}

      {{- /* Create item object with all data */ -}}
      {{- $item := dict
          "id" .File.UniqueID
          "name" .Title
          "linkTitle" .LinkTitle
          "url" .RelPermalink
          "section" .Parent.Section
          "category" .Parent.Title
          "categoryUrl" .Parent.RelPermalink
          "summary" .Summary
          "sizes" $sizes
          "flavours" (sort $flavours)
          "prices" $prices
          "side_categories" $sideCategories
          "sides" $sides
          "sideconfig" $sideconfig
          "additions" $additions
          "modifications" $modifications
          "images" $images
          "tags" $tags
          "ingredients" $ingredients
          "cookingmethods" $cookingmethods
          "types" $types
          "events" $events
      -}}
      {{- $menuItems = $menuItems | append $item -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $json := dict
    "menu_items" $menuItems
    "total_count" (len $menuItems)
    "generated_at" now
-}}

{{ $json | jsonify }}
