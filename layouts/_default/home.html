{{ define "main" }}
  <div class="hero_logo_container item">
  {{ if .Params.image }}
    <img id="bg" src="{{ .Params.image }}" alt="{{ site.Title }} background" fetchpriority="high">
  {{ else }}
    <img id="bg" src="/main/bg.webp" alt="{{ site.Title }} background" fetchpriority="high">
  {{ end }}
  <div class="logo_container">
    <a href="/locations/"><img id="logo" src="/branding/favicon512.webp" alt="{{ site.Title }} logo" width="512" height="512"></a>
  </div>
  </div> 
  {{ partial "components/contact_info.html" . }}
  <div class="hero-content">
    {{ .Content }}
    {{ partial "client/clienttourimages.html" . }}
    {{ partial "socialmedia/share-button.html" . }}
    
  </div>
  {{ $advertisementsRendered := false }}
  {{ range site.Pages.ByWeight }}
    {{ if and (not .IsPage) (not .IsHome)}}
      {{ $title:= .LinkTitle }}
      {{ $titleurl := .RelPermalink }}
      {{ if not (or (in $titleurl "admins") (in $titleurl "admin")) }}
        {{ if and (eq $title ("Promotions")) (not $advertisementsRendered) }}
          {{/* Only render the first "Promotions" section found to avoid duplicates */}}
          <h2 id="{{ $title }}" class="center title item" data-aos="zoom-out-right" data-aos-offset="50">
            <a href="{{ $titleurl }}">{{ $title }}</a>
          </h2>
          {{ partial "ads/homepageclientads.html" . }} 
          {{ $advertisementsRendered = true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ partial "ads/frontpageads.html" . }}
  <div class="main-body" id="packery-container">
  {{ range site.Pages.ByWeight }}
    {{ if and (not .IsPage) (not .IsHome)}}
      {{ $title:= .LinkTitle }}
      {{ $titleurl := .RelPermalink }}  
      {{ if ne $title ("Promotions") }}
        {{ if .RegularPages }}
          {{ if not (or (in $titleurl "tags") (in $titleurl "categories") (in $titleurl "subcategories") (in $titleurl "types") (in $titleurl "events") (in $titleurl "ingredients") (in $titleurl "cookingmethods") (in $titleurl "admins") (in $titleurl "admin")) }}
              <div class="main-menu-bg {{ .LinkTitle }}">
                <div class="main-menu {{ .LinkTitle }} item">
                  <div class="menu-header">
                    <a class="menu-anchor" id="{{ .LinkTitle }}"></a>
                    {{ if .Params.image }}
                      <a  href="{{ .RelPermalink }}"><img class="food item aos-init aos-animate" data-aos="zoom-out" src="{{ .Params.image }}" alt="{{ .LinkTitle }}" loading="lazy"></a>
                    {{ end }}
                    <div class="headerstyle item" >
                      <h2 class="center title" data-aos="zoom-out-right" data-aos-offset="50">
                        <a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
                        {{ if .Params.slidein }}
                          <img class="slideinimg aos-init aos-animate" data-aos="zoom-out-{{ .Params.slidein.direction }}" src="{{ .Params.slidein.slideinimage }}" alt="{{ .LinkTitle }} decoration" loading="lazy">
                        {{ end }}
                      </h2>
                      
                    </div>
                    <div class="menu-summary item">
                      {{ .Summary }}
                    </div>
                  </div>
                  <div class="menu-items-container">
                      {{ $category := .LinkTitle }}
                      {{ $categoryurl := .RelPermalink }}            
                      {{ range .RegularPages.ByWeight }}

                        {{$sizes := slice}}
                        {{range .Params.prices}}
                          {{if not (in $sizes .size)}}
                            {{$sizes = $sizes | append .size}}
                          {{end}}
                        {{end}}

                        {{$flavours := slice}}
                        {{range .Params.prices}}
                          {{if not (in $flavours .flavour)}}
                            {{$flavours = $flavours | append .flavour}}
                          {{end}}
                        {{end}}
                        
                        {{/* Build prices array for JavaScript */}}
                        {{$pricesArray := slice}}
                        {{range .Params.prices}}
                          {{$pricesArray = $pricesArray | append .size}}
                          {{$pricesArray = $pricesArray | append .flavour}}
                          {{$pricesArray = $pricesArray | append .price}}
                        {{end}}
                        
                        {{/* Build side categories data */}}
                        {{$sideCategories := slice}}
                        {{if .Params.side_categories}}
                          {{range .Params.side_categories}}
                            {{$category := dict}}
                            {{$category = merge $category (dict "category_name" .category_name)}}
                            {{$category = merge $category (dict "display_name" .display_name)}}
                            {{$items := slice}}
                            {{range .items}}
                              {{$item := slice}}
                              {{$item = $item | append .name}}
                              {{$item = $item | append .type}}
                              {{$item = $item | append .price}}
                              {{$items = $items | append $item}}
                            {{end}}
                            {{$category = merge $category (dict "items" $items)}}
                            {{if .config}}
                              {{$config := slice}}
                              {{$config = $config | append .config.all_max}}
                              {{$config = $config | append .config.all_valuecount}}
                              {{$config = $config | append .config.all_value}}
                              {{$config = $config | append .config.regular_max}}
                              {{$config = $config | append .config.regular_valuecount}}
                              {{$config = $config | append .config.regular_value}}
                              {{$config = $config | append .config.premium_max}}
                              {{$config = $config | append .config.premium_valuecount}}
                              {{$config = $config | append .config.premium_value}}
                              {{$category = merge $category (dict "config" $config)}}
                            {{end}}
                            {{$sideCategories = $sideCategories | append $category}}
                          {{end}}
                        {{end}}
                        
                        {{/* Build modifications data */}}
                        {{$modifications := slice}}
                        {{if .Params.modifications}}
                          {{range .Params.modifications}}
                            {{$modifications = $modifications | append .name}}
                            {{$modifications = $modifications | append .price}}
                          {{end}}
                        {{end}}
                        
                        {{/* Build additions data */}}
                        {{$additions := slice}}
                        {{if .Params.additions}}
                          {{range .Params.additions}}
                            {{$additions = $additions | append .name}}
                            {{$additions = $additions | append .price}}
                          {{end}}
                        {{end}}
                        
                        {{/* Build images array for carousel */}}
                        {{$imagesArray := slice}}
                        {{if .Params.images}}
                          {{range .Params.images}}
                            {{if .image}}
                              {{$imagesArray = $imagesArray | append .image}}
                            {{end}}
                          {{end}}
                        {{end}}
                        
                        {{/* Determine default selected size and flavour */}}
                        {{$defaultSize := "-"}}
                        {{if gt (len $sizes) 0}}
                          {{$defaultSize = index $sizes 0}}
                        {{end}}
                        {{$defaultFlavour := "-"}}
                        {{if gt (len $flavours) 0}}
                          {{$defaultFlavour = index $flavours 0}}
                        {{end}}
     
                        <div class="menu-item-card" 
                            data-item-url="{{ .RelPermalink }}"
                            data-item-expanded="false"
                            data-prices-array="{{ $pricesArray | jsonify }}"
                            data-selected-size="{{ $defaultSize }}"
                            data-selected-flavour="{{ $defaultFlavour }}"
                            data-side-categories="{{ $sideCategories | jsonify }}"
                            data-modifications="{{ $modifications | jsonify }}"
                            data-additions="{{ $additions | jsonify }}"
                            data-images-array="{{ $imagesArray | jsonify }}"
                            onclick="toggleItemExpansion(this, '{{ .RelPermalink }}', event);">
                            <div class="menu-item-row-top">
                              {{ if .Params.images }}
                                {{ $firstImage := index .Params.images 0 }}
                                {{ if $firstImage.image }}
                                  <a href="{{ .RelPermalink }}" class="menu-item-image-link">
                                    <div class="menu-item-image">
                                      <img src="/{{ $firstImage.image }}" alt="{{ .LinkTitle }}" loading="lazy" class="menu-item-img">
                                    </div>
                                  </a>
                                {{ end }}
                              {{ end }}
                              <div class="menu-item-header-content">
                                <h3 class="menu-item-title">
                                  <a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
                                </h3>
                                <div class="menu-item-row-middle">
                                  <div class="menu-item-description">
                              {{ .Summary }}
                                  </div>
                                  <div class="menu-item-price">
                                    {{$counter := 0}}
                                    {{$number := slice}}
                                    {{$total := 0}}
                                    {{range .Params.prices}}
                                      {{$counter = add $counter 1}}
                                      {{$number = $number | append .price}}
                                      {{$total = add $total .price}}
                                    {{end}} 
                                    {{$number := sort $number}}
                                    {{ if eq (index $number 0) (index $number (sub $counter 1)) }}
                                      {{ $price := float (index $number (sub $counter 1)) }}
                                      ${{ (printf "%.2f" $price) | replaceRE "\\.00$" "" }}
                                    {{else }}
                                      {{ $price1 := float (index $number 0) }}
                                      {{ $price2 := float (index $number (sub $counter 1)) }}
                                      ${{ (printf "%.2f" $price1) | replaceRE "\\.00$" "" }} | ${{ (printf "%.2f" $price2) | replaceRE "\\.00$" "" }}      
                                    {{ end }}
                                  </div>
                                </div>
                                <div class="menu-item-options">
                              <ul class="sizes">
                                {{ range $index, $currentItem := $sizes }}
                                  {{ if not (or (eq $currentItem "-") (eq $currentItem "None")) }}
                                    <li>
                                      {{ $currentItem }}
                                    </li>
                                  {{ end }}
                                {{ end }}
                              </ul>
                              <ul class="flavours">
                                {{ range $index, $currentItem := $flavours }}
                                  {{ if not (or (eq $currentItem "-") (eq $currentItem "None")) }}
                                    <li>
                                      {{ $currentItem }}
                                    </li>
                                  {{ end }}
                                {{ end }}
                              </ul> 
                                </div>
                              </div>
                            </div>
                            <!-- Expanded content area (hidden by default) -->
                            <div class="menu-item-expanded-content" style="display: none;">
                              <div class="menu-item-expanded-loading">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Loading...</div>
                              </div>
                              <div class="menu-item-expanded-data" style="display: none;"></div>
                            </div>
                        </div>
                        
                      {{ end }}
                  </div> 
                </div>
              </div>
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  </div>
  
{{ end }}
