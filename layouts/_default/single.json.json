{{- if not (eq .Section "promotions") -}}
  {{- $category := .Section -}}
  {{- $categoryurl := .Parent.Permalink -}}
  
  {{- $sizes := slice -}}
  {{- range .Params.prices -}}
    {{- if not (in $sizes .size) -}}
      {{- $sizes = $sizes | append .size -}}
    {{- end -}}
  {{- end -}}

  {{- $flavours := slice -}}
  {{- range .Params.prices -}}
    {{- if not (in $flavours .flavour) -}}
      {{- $flavours = $flavours | append .flavour -}}
    {{- end -}}
  {{- end -}}

  {{- $prices := slice -}}
  {{- range .Params.prices -}}
    {{- $price := slice -}}
    {{- $price = $price | append .size -}}
    {{- $price = $price | append .flavour -}}
    {{- $price = $price | append .price -}}
    {{- $prices = $prices | append $price -}}
  {{- end -}}

  {{- $sides := slice -}}
  {{- range .Params.sides -}}
    {{- $side := slice -}}
    {{- $side = $side | append .name -}}
    {{- $side = $side | append .type -}}
    {{- $side = $side | append .price -}}
    {{- $sides = $sides | append $side -}}
  {{- end -}}

  {{- $sideconfig := slice -}}
  {{- if .Params.side_config -}}
    {{- $config := slice -}}
    {{- $config = $config | append .Params.side_config.all_max -}}
    {{- $config = $config | append .Params.side_config.all_valuecount -}}
    {{- $config = $config | append .Params.side_config.all_value -}}
    {{- $config = $config | append .Params.side_config.regular_max -}}
    {{- $config = $config | append .Params.side_config.regular_valuecount -}}
    {{- $config = $config | append .Params.side_config.regular_value -}}
    {{- $config = $config | append .Params.side_config.premium_max -}}
    {{- $config = $config | append .Params.side_config.premium_valuecount -}}
    {{- $config = $config | append .Params.side_config.premium_value -}}
    {{- $sideconfig = $sideconfig | append $config -}}
  {{- end -}}

  {{- /* Build side categories array (new structure) */ -}}
  {{- $sideCategories := slice -}}
  {{- if .Params.side_categories -}}
    {{- range .Params.side_categories -}}
      {{- $category := dict -}}
      {{- $category = merge $category (dict "category_name" .category_name) -}}
      {{- $category = merge $category (dict "display_name" .display_name) -}}
      
      {{- /* Build items for this category */ -}}
      {{- $items := slice -}}
      {{- range .items -}}
        {{- $item := slice -}}
        {{- $item = $item | append .name -}}
        {{- $item = $item | append .type -}}
        {{- $item = $item | append .price -}}
        {{- $items = $items | append $item -}}
      {{- end -}}
      {{- $category = merge $category (dict "items" $items) -}}
      
      {{- /* Build config for this category */ -}}
      {{- if .config -}}
        {{- $config := slice -}}
        {{- $config = $config | append .config.all_max -}}
        {{- $config = $config | append .config.all_valuecount -}}
        {{- $config = $config | append .config.all_value -}}
        {{- $config = $config | append .config.regular_max -}}
        {{- $config = $config | append .config.regular_valuecount -}}
        {{- $config = $config | append .config.regular_value -}}
        {{- $config = $config | append .config.premium_max -}}
        {{- $config = $config | append .config.premium_valuecount -}}
        {{- $config = $config | append .config.premium_value -}}
        {{- $category = merge $category (dict "config" $config) -}}
      {{- end -}}
      
      {{- $sideCategories = $sideCategories | append $category -}}
    {{- end -}}
  {{- end -}}

  {{- $additions := slice -}}
  {{- range .Params.additions -}}
    {{- $addition := slice -}}
    {{- $addition = $addition | append .name -}}
    {{- $addition = $addition | append .price -}}
    {{- $additions = $additions | append $addition -}}
  {{- end -}}
  
  {{- $modifications := slice -}}
  {{- range .Params.modifications -}}
    {{- $modification := slice -}}
    {{- $modification = $modification | append .name -}}
    {{- $modification = $modification | append .price -}}
    {{- $modifications = $modifications | append $modification -}}
  {{- end -}}
  
  {{- $images := slice -}}
  {{- range .Params.images -}}
    {{- $images = $images | append .image -}}
  {{- end -}}

  {{- $json := dict
    "category" $category
    "categoryurl" $categoryurl
    "name" .LinkTitle
    "url" .RelPermalink
    "images" $images
    "desc" .Summary
    "sizes" $sizes
    "flavours" (sort $flavours)
    "items" $prices
    "sides" $sides
    "sideoptions" $sideconfig
    "side_categories" $sideCategories
    "additions" $additions
    "modifications" $modifications
    "title" .Title
    "content" .Content
    "date" .Date
    "weight" (.Params.weight | default 0)
    "tags" (.Params.tags | default slice)
    "types" (.Params.types | default slice)
    "events" (.Params.events | default slice)
    "ingredients" (.Params.ingredients | default slice)
    "cookingmethods" (.Params.cookingmethods | default slice)
    "daysofweek" (.Params.daysofweek | default slice)
  -}}

  {{- $json | jsonify -}}
{{- else -}}
  {{- $adLocations := slice -}}
  {{- with site.Data.locations.locations }}
    {{- range . }}
      {{- $locationData := dict
          "address"  .address
          "city"     .city
          "island"   .island
          "subcategories"  .subcategories
          "latlon"    .latlon
          "phone"    .phone
          "delivery" .delivery
          "opening_hours" .opening_hours
        -}}
      {{- $adLocations = $adLocations | append $locationData -}}
    {{- end }}
  {{- end }}

  {{- $eventdates := slice -}}
  {{- range $i, $ev := .Params.eventdates }}
    {{- if and $ev.start $ev.end }}
      {{- $eventdates = $eventdates | append (dict "start" $ev.start "end" $ev.end) }}
    {{- end }}
  {{- end }}

  {{- $json := dict
    "title" .Title
    "url" .RelPermalink
    "date" .Date
    "content" .Content
    "images" (.Params.images | default slice)
    "link" (.Params.link | default "")
    "locations" $adLocations
    "recurring" (.Params.recurring | default false)
    "daysofweek" (.Params.daysofweek | default slice)
    "youtube" (.Params.youtube | default slice)
    "eventdates" $eventdates
  -}}

  {{- $json | jsonify -}}
{{- end -}}
