{{ define "main" }}
  

  <!--{{ $dateMachine := .Date | time.Format "2006-01-02T15:04:05-07:00" }}
  {{ $dateHuman := .Date | time.Format ":date_long" }}
  <time datetime="{{ $dateMachine }}">{{ $dateHuman }}</time-->
  {{if not (eq .Section ("promotions")) }}
    <div class="main-content">
      <div class="single-page-item-card">
        {{ $category :=  .Section  }}
        {{ $categoryurl := .Parent.Permalink }}            
        {{$sizes := slice}}
        {{if .Params.prices}}
          {{range .Params.prices}}
            {{if not (in $sizes .size)}}
              {{$sizes = $sizes | append .size}}
            {{end}}
          {{end}}
        {{end}}

        {{$flavours := slice}}
        {{if .Params.prices}}
          {{range .Params.prices}}
            {{if not (in $flavours .flavour)}}
              {{$flavours = $flavours | append .flavour}}
            {{end}}
          {{end}}
        {{end}}
        
              {{if .Params.images }}
          <div class="single-page-image-container">
                {{range .Params.images }}
              <img class="single-page-image" src="/{{ .image }}" alt="{{ $.Title }}" loading="lazy">
                {{ end }}
              </div>
              {{ else }}
          <div class="single-page-image-container">
            <img class="single-page-image" src="/branding/favicon-400x200.webp" alt="{{ .Title }}" loading="lazy">  
          </div>
              {{ end }}  
        
        <div class="single-page-content">
          <h1 class="single-page-title">{{ .Title }}</h1>
          
          <div class="single-page-description">
              {{ .Content }}
          </div>
          
              {{$allprices := .Params.prices | default slice}}
          {{/* Only show prices section if there are no interactive options to select */}}
          {{ $hasSideCategories := and .Params.side_categories (gt (len .Params.side_categories) 0) }}
          {{ $hasAdditions := and .Params.additions (gt (len .Params.additions) 0) }}
          {{ $hasSelectableOptions := or (gt (len $sizes) 1) (gt (len $flavours) 1) $hasSideCategories $hasAdditions }}
          {{ if and $allprices (gt (len $allprices) 0) (not $hasSelectableOptions) }}
            <div class="single-page-prices-section">
              {{ range $index, $currentItem := $sizes }}
                {{ if ne $currentItem "-" }}
                  <div class="price-group">
                    <h3 class="price-group-title">{{ $currentItem }}</h3>
                    <ul class="prices">
                      {{ range $allprices }}
                        {{ if eq $currentItem .size }}
                          <li>
                            {{ $price := float .price }}
                            {{ if and .flavour (ne .flavour "-") }}{{ .flavour }} {{ end }}<b>${{ (printf "%.2f" $price) | replaceRE "\\.00$" "" }}</b>
                          </li>
                        {{ end }}
                      {{ end }}
                    </ul>
                  </div>
                {{ end }}
              {{ end }}
              {{/* Show single price if no sizes or all sizes are "-" */}}
              {{ if or (eq (len $sizes) 0) (and (eq (len $sizes) 1) (eq (index $sizes 0) "-")) }}
                {{ $firstPrice := index $allprices 0 }}
                {{ if $firstPrice }}
                  <div class="price-group">
                    <ul class="prices">
                      <li>
                        {{ $price := float $firstPrice.price }}
                        <b>${{ (printf "%.2f" $price) | replaceRE "\\.00$" "" }}</b>
                      </li>
                    </ul>
                  </div>
                {{ end }}
              {{ end }}
            </div>
          {{ end }}
          
          {{/* Build side categories data */}}
          {{ $sideCategories := slice }}
          {{ if .Params.side_categories }}
            {{ range .Params.side_categories }}
              {{ $category := dict }}
              {{ $category = merge $category (dict "category_name" .category_name) }}
              {{ $category = merge $category (dict "display_name" .display_name) }}
              {{ $items := slice }}
              {{ range .items }}
                {{ $item := slice }}
                {{ $item = $item | append .name }}
                {{ $item = $item | append .type }}
                {{ $item = $item | append .price }}
                {{ $items = $items | append $item }}
              {{ end }}
              {{ $category = merge $category (dict "items" $items) }}
              {{ if .config }}
                {{ $config := slice }}
                {{ $config = $config | append .config.all_max }}
                {{ $config = $config | append .config.all_valuecount }}
                {{ $config = $config | append .config.all_value }}
                {{ $config = $config | append .config.regular_max }}
                {{ $config = $config | append .config.regular_valuecount }}
                {{ $config = $config | append .config.regular_value }}
                {{ $config = $config | append .config.premium_max }}
                {{ $config = $config | append .config.premium_valuecount }}
                {{ $config = $config | append .config.premium_value }}
                {{ $category = merge $category (dict "config" $config) }}
              {{ end }}
              {{ $sideCategories = $sideCategories | append $category }}
            {{ end }}
          {{ end }}
          
          {{/* Build additions data */}}
          {{ $additions := slice }}
          {{ range .Params.additions }}
            {{ $additions = $additions | append .name }}
            {{ $additions = $additions | append .price }}
          {{ end }}
          
          {{/* Build prices array for JavaScript */}}
          {{ $pricesArray := slice }}
          {{ if .Params.prices }}
            {{ range .Params.prices }}
              {{ $pricesArray = $pricesArray | append .size }}
              {{ $pricesArray = $pricesArray | append .flavour }}
              {{ $pricesArray = $pricesArray | append .price }}
            {{ end }}
          {{ end }}
          
          {{/* Store data in data attributes for JavaScript */}}
          <div id="single-page-item-data" 
               data-prices-array="{{ $pricesArray | jsonify }}"
               data-sizes="{{ $sizes | jsonify }}"
               data-flavours="{{ $flavours | jsonify }}"
               data-side-categories="{{ $sideCategories | jsonify }}"
               data-additions="{{ $additions | jsonify }}"
               data-item-url="{{ .RelPermalink }}"
               style="display: none;"></div>
          
          {{/* Options Sections */}}
          {{ if or (gt (len $sizes) 1) (gt (len $flavours) 1) (gt (len $sideCategories) 0) (gt (len $additions) 0) }}
            <div class="single-page-options-section">
              {{/* Sizes */}}
              {{ if gt (len $sizes) 1 }}
                <div class="single-page-options-group">
                  <h4 class="single-page-options-title">Size</h4>
                  <ul class="single-page-options-list">
                    {{ range $index, $size := $sizes }}
                      <li class="single-page-option {{ if eq $index 0 }}selected{{ end }}" 
                          data-option-type="size" 
                          data-option-value="{{ $size }}"
                          onclick="selectSinglePageOption(this, event)">
                        {{ $size }}
                      </li>
                    {{ end }}
                  </ul>
                </div>
              {{ end }}
              
              {{/* Flavours */}}
              {{ if gt (len $flavours) 1 }}
                <div class="single-page-options-group">
                  <h4 class="single-page-options-title">Flavour</h4>
                  <ul class="single-page-options-list">
                    {{ range $index, $flavour := $flavours }}
                      <li class="single-page-option {{ if eq $index 0 }}selected{{ end }}" 
                          data-option-type="flavour" 
                          data-option-value="{{ $flavour }}"
                          onclick="selectSinglePageOption(this, event)">
                        {{ $flavour }}
                      </li>
                    {{ end }}
                  </ul>
                </div>
              {{ end }}
              
              {{/* Side Categories */}}
              {{ if .Params.side_categories }}
                <div class="single-page-side-categories">
                  {{ range .Params.side_categories }}
                    {{ $categoryName := .category_name }}
                    <div class="single-page-side-category" data-category-name="{{ $categoryName }}">
                      <h4 class="single-page-side-category-title">{{ .display_name }}</h4>
                      <ul class="single-page-side-items">
                        {{ range .items }}
                          <li class="single-page-side-option regularside" 
                              data-category="{{ $categoryName }}"
                              data-item-name="{{ .name }}"
                              data-item-type="{{ .type }}"
                              data-item-price="{{ .price }}"
                              onclick="selectSinglePageSide(this, event)">
                            {{ .name }}
                          </li>
                        {{ end }}
                      </ul>
                    </div>
                  {{ end }}
                </div>
              {{ end }}
              
              {{/* Additions */}}
              {{ if gt (len $additions) 0 }}
                <div class="single-page-additions">
                  <h4 class="single-page-additions-title">Additions</h4>
                  <ul class="single-page-addition-items">
                    {{ range .Params.additions }}
                      <li class="single-page-addition-option" 
                          data-addition-name="{{ .name }}"
                          data-addition-price="{{ .price }}"
                          onclick="selectSinglePageAddition(this, event)">
                        {{ .name }} <span class="addition-price">+${{ (printf "%.2f" (float .price)) | replaceRE "\\.00$" "" }}</span>
                      </li>
                    {{ end }}
                  </ul>
                </div>
              {{ end }}
            </div>
          {{ end }}
          
          <!-- Add to Cart Section -->
          <div class="single-page-add-cart">
            <div class="single-page-quantity-control">
              <button class="btn-quantity" onclick="adjustSinglePageQuantity(this, -1)">
                <i class="fa fa-chevron-down"></i>
              </button>
              <span class="single-page-quantity" data-item-url="{{ .RelPermalink }}">1</span>
              <button class="btn-quantity" onclick="adjustSinglePageQuantity(this, 1)">
                <i class="fa fa-chevron-up"></i>
              </button>
              <span class="single-page-price">
                {{$counter := 0}}
                {{$number := slice}}
                {{$total := 0}}
                {{if .Params.prices}}
                  {{range .Params.prices}}
                    {{$counter = add $counter 1}}
                    {{$number = $number | append .price}}
                    {{$total = add $total .price}}
                  {{end}}
                {{end}} 
                {{if gt $counter 0}}
                  {{$number := sort $number}}
                  {{ if eq (index $number 0) (index $number (sub $counter 1)) }}
                    {{ $price := float (index $number (sub $counter 1)) }}
                    ${{ (printf "%.2f" $price) | replaceRE "\\.00$" "" }}
                  {{else }}
                    {{ $price1 := float (index $number 0) }}
                    {{ $price2 := float (index $number (sub $counter 1)) }}
                    ${{ (printf "%.2f" $price1) | replaceRE "\\.00$" "" }} | ${{ (printf "%.2f" $price2) | replaceRE "\\.00$" "" }}      
                  {{ end }}
                {{end}}
              </span>
            </div>
            <button class="single-page-add-cart-btn" onclick="addSinglePageItemToCart(this, '{{ .RelPermalink }}')">
              <i class="fa fa-cart-plus"></i>
              <span class="cart-button-text">Add to Cart</span>
              <span class="cart-button-price"></span>
            </button>
          </div>
        </div>
      </div>
  {{ else }}
    <div class="singlepagemenu {{ .Section }}">
      {{ if gt (len .Params.images) 0 }}
        <a href="{{ .Params.link }}" class="singlepageimages">
          {{ range .Params.images }}
            <img src="/{{ .image }}" alt="{{ $.Title }}" loading="lazy">
          {{ end }}
        </a>
      {{ else }}
        <img id="singlepageimage" src="/branding/favicon-400x200.webp" alt="{{ .Title }}" loading="lazy">  
      {{ end }}  
      <h1>{{ .Title }}</h1>
      {{ range .Params.youtube }}
        <iframe style="margin-inline: auto;display: block;" width="315" height="560" 
            src="{{ .url }}" 
            title="YouTube video player" 
            frameborder="0" 
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
            allowfullscreen>
        </iframe>
      {{ end }}
      {{ .Content }}
    </div>
  {{ end }}
  {{ partial "utilities/terms.html" (dict "taxonomy" "tags" "page" .) }}
  {{ partial "utilities/terms.html" (dict "taxonomy" "ingredients" "page" .) }}
  {{ partial "utilities/terms.html" (dict "taxonomy" "cookingmethods" "page" .) }}
  {{ partial "utilities/terms.html" (dict "taxonomy" "types" "page" .) }}
  {{ partial "utilities/terms.html" (dict "taxonomy" "events" "page" .) }}
  
  {{ partial "socialmedia/share-button.html" . }}
{{ end }}
