{{ warnf "Generating JSON file for section: %s" .Section }}

{{- $items := slice -}}

{{- range $index, $page := .Pages }}
  {{ warnf "- Processing item file in section: %s || %s" $.Section $page.Title }}

  {{- $item := dict
      "title"  $page.Title
      "weight" ($page.Params.weight | default 0)
      "date"   $page.Date
      "images" ($page.Params.images | default slice)
      "body"   ($page.Params.body | default "")
      "tags"   ($page.Params.tags | default slice)
      "categories"  ($page.Params.categories | default slice)
      "subcategories"  ($page.Params.subcategories | default slice)
      "types"  ($page.Params.types | default slice)
      "events" ($page.Params.events | default slice)
      "ingredients" ($page.Params.ingredients | default slice)
      "cookingmethods" ($page.Params.cookingmethods | default slice)
  -}}

  {{- if eq $.Section "advertisments" }}
    {{- $adLocations := slice -}}
    {{- with site.Data.locations.locations }}
      {{- range . }}
        {{- $locationData := dict
            "address"  .address
            "city"     .city
            "island"   .island
            "subcategories"  .subcategories
            "latlon"    .latlon
            "phone"    .phone
            "delivery" .delivery
            "opening_hours" .opening_hours
          -}}
        {{- $adLocations = $adLocations | append $locationData -}}
      {{- end }}
    {{- end }}

    {{ warnf "  ↪ Ad: %s | Locations: %d | Recurring: %v" $page.Title (len $adLocations) ($page.Params.recurring | default false) }}

    {{- $item = merge $item (dict
      "locations" $adLocations
      "recurring" ($page.Params.recurring | default false)
      "daysofweek" ($page.Params.daysofweek | default slice)
      "youtube"  ($page.Params.youtube | default slice)
    ) }}

    {{- $eventdates := slice -}}
    {{- range $i, $ev := $page.Params.eventdates }}
      {{- if and $ev.start $ev.end }}
        {{- $eventdates = $eventdates | append (dict "start" $ev.start "end" $ev.end) }}
      {{- else }}
        {{ warnf "    ⚠️ Incomplete event date in ad: %s" $page.Title }}
      {{- end }}
    {{- end }}

    {{- $item = merge $item (dict "eventdates" $eventdates) }}

  {{- else }}
    {{- $item = merge $item (dict
        "url"           $page.RelPermalink
        "link"          ($page.Params.link | default "")
    ) }}
  {{- end }}

  {{- $items = $items | append $item -}}
{{- end }}

{{- $json := dict "items" $items -}}
{{- $json | jsonify -}}
