{{ define "main" }}
  {{ if eq .LinkTitle ("Promotions") }}
    <h1 data-aos="zoom-out-right">{{ .Title }}</h1>
    {{ partial "ads/clientads.html" . }}
  {{ else }}
    <div class="main-content">
      
      {{ if .Params.image }}
        <img class="food item listpageimage" src="/{{ .Params.image }}">
      {{ end }}
      <div class="headerstyle item">
        <h1 data-aos="zoom-out-right">{{ .Title }}</h1>
        {{ if .Params.slidein }}
          <img class="slideinimg aos-init aos-animate" data-aos="zoom-out-{{ .Params.slidein.direction }}" src="/{{ .Params.slidein.slideinimage }}">
        {{ end }}
      </div>
      <h4 class="menu-summary item">{{ .Content }}</h4>
      
          {{ $category := .LinkTitle }}
          {{ $categoryurl := .RelPermalink }}            
          <div class="menu-items-container">
          {{ range .RegularPages.ByWeight }}
            {{ if ne $category ("Promotions") }}
                  {{$sizes := slice}}
                  {{range .Params.prices}}
                    {{if not (in $sizes .size)}}
                      {{$sizes = $sizes | append .size}}
                    {{end}}
                  {{end}}

                  {{$flavours := slice}}
                  {{range .Params.prices}}
                    {{if not (in $flavours .flavour)}}
                      {{$flavours = $flavours | append .flavour}}
                    {{end}}
                  {{end}}
                  
                  {{/* Build prices array for JavaScript */}}
                  {{$pricesArray := slice}}
                  {{range .Params.prices}}
                    {{$pricesArray = $pricesArray | append .size}}
                    {{$pricesArray = $pricesArray | append .flavour}}
                    {{$pricesArray = $pricesArray | append .price}}
                  {{end}}
                  
                  {{/* Build side categories data */}}
                  {{$sideCategories := slice}}
                  {{if .Params.side_categories}}
                    {{range .Params.side_categories}}
                      {{$category := dict}}
                      {{$category = merge $category (dict "category_name" .category_name)}}
                      {{$category = merge $category (dict "display_name" .display_name)}}
                      {{$items := slice}}
                      {{range .items}}
                        {{$item := slice}}
                        {{$item = $item | append .name}}
                        {{$item = $item | append .type}}
                        {{$item = $item | append .price}}
                        {{$items = $items | append $item}}
                      {{end}}
                      {{$category = merge $category (dict "items" $items)}}
                      {{if .config}}
                        {{$config := slice}}
                        {{$config = $config | append .config.all_max}}
                        {{$config = $config | append .config.all_valuecount}}
                        {{$config = $config | append .config.all_value}}
                        {{$config = $config | append .config.regular_max}}
                        {{$config = $config | append .config.regular_valuecount}}
                        {{$config = $config | append .config.regular_value}}
                        {{$config = $config | append .config.premium_max}}
                        {{$config = $config | append .config.premium_valuecount}}
                        {{$config = $config | append .config.premium_value}}
                        {{$category = merge $category (dict "config" $config)}}
                      {{end}}
                      {{$sideCategories = $sideCategories | append $category}}
                    {{end}}
                  {{end}}
                  
                  {{/* Build modifications data */}}
                  {{$modifications := slice}}
                  {{if .Params.modifications}}
                    {{range .Params.modifications}}
                      {{$modifications = $modifications | append .name}}
                      {{$modifications = $modifications | append .price}}
                    {{end}}
                  {{end}}
                  
                  {{/* Build additions data */}}
                  {{$additions := slice}}
                  {{if .Params.additions}}
                    {{range .Params.additions}}
                      {{$additions = $additions | append .name}}
                      {{$additions = $additions | append .price}}
                    {{end}}
                  {{end}}
                  
                  {{/* Build images array for carousel */}}
                  {{$imagesArray := slice}}
                  {{if .Params.images}}
                    {{range .Params.images}}
                      {{if .image}}
                        {{$imagesArray = $imagesArray | append .image}}
                      {{end}}
                    {{end}}
                  {{end}}
                  
                  {{/* Determine default selected size and flavour */}}
                  {{$defaultSize := "-"}}
                  {{if gt (len $sizes) 0}}
                    {{$defaultSize = index $sizes 0}}
                  {{end}}
                  {{$defaultFlavour := "-"}}
                  {{if gt (len $flavours) 0}}
                    {{$defaultFlavour = index $flavours 0}}
                  {{end}}
                  
                <div class="menu-item-card" 
                      data-item-url="{{ .RelPermalink }}"
                    data-item-expanded="false"
                    data-prices-array="{{ $pricesArray | jsonify }}"
                    data-selected-size="{{ $defaultSize }}"
                    data-selected-flavour="{{ $defaultFlavour }}"
                    data-side-categories="{{ $sideCategories | jsonify }}"
                    data-modifications="{{ $modifications | jsonify }}"
                    data-additions="{{ $additions | jsonify }}"
                    data-images-array="{{ $imagesArray | jsonify }}"
                    onclick="toggleItemExpansion(this, '{{ .RelPermalink }}', event);">
                    <div class="menu-item-row-top">
                      {{ if .Params.images }}
                        {{ $firstImage := index .Params.images 0 }}
                        {{ if $firstImage.image }}
                          <a href="{{ .RelPermalink }}" class="menu-item-image-link">
                            <div class="menu-item-image">
                              <img src="/{{ $firstImage.image }}" alt="{{ .LinkTitle }}" loading="lazy" class="menu-item-img">
                            </div>
                          </a>
                        {{ end }}
                      {{ end }}
                      <div class="menu-item-header-content">
                        <h3 class="menu-item-title">
                          <a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
                        </h3>
                        <div class="menu-item-row-middle">
                          <div class="menu-item-description">
                        {{ .Summary }}
                          </div>
                          <div class="menu-item-price">
                            {{$counter := 0}}
                            {{$number := slice}}
                            {{$total := 0}}
                            {{range .Params.prices}}
                              {{$counter = add $counter 1}}
                              {{$number = $number | append .price}}
                              {{$total = add $total .price}}
                            {{end}} 
                            {{$number := sort $number}}
                            {{ if eq (index $number 0) (index $number (sub $counter 1)) }}
                              {{ $price := float (index $number (sub $counter 1)) }}
                              ${{ (printf "%.2f" $price) | replaceRE "\\.00$" "" }}
                            {{else }}
                              {{ $price1 := float (index $number 0) }}
                              {{ $price2 := float (index $number (sub $counter 1)) }}
                              ${{ (printf "%.2f" $price1) | replaceRE "\\.00$" "" }} | ${{ (printf "%.2f" $price2) | replaceRE "\\.00$" "" }}      
                            {{ end }}
                          </div>
                        </div>
                        <div class="menu-item-options">
                        <ul class="sizes">
                          {{ range $index, $currentItem := $sizes }}
                            {{ if not (or (eq $currentItem "-") (eq $currentItem "None")) }}
                              <li>
                                {{ $currentItem }}
                              </li>
                            {{ end }}
                          {{ end }}
                        </ul>
                        <ul class="flavours">
                          {{ range $index, $currentItem := $flavours }}
                            {{ if not (or (eq $currentItem "-") (eq $currentItem "None")) }}
                              <li>
                                {{ $currentItem }}
                              </li>
                            {{ end }}
                          {{ end }}
                        </ul> 
                        </div>
                      </div>
                    </div>
                    <!-- Expanded content area (hidden by default) -->
                    <div class="menu-item-expanded-content" style="display: none;">
                      <div class="menu-item-expanded-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading...</div>
                      </div>
                      <div class="menu-item-expanded-data" style="display: none;"></div>
                    </div>
                </div>
                        {{ end }}                       
            {{ end }}
          </div>

    </div>
  {{ end }}
  {{ partial "socialmedia/share-button.html" . }}
{{ end }}
